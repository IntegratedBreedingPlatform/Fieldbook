<div class="col-xs-7 col-md-7" xmlns:th="http://www.thymeleaf.org">
	<!-- Modal -->

	<form  id="importStudyUploadForm"
	method="post" th:object="${createNurseryForm}"
	enctype="multipart/form-data">

		<div class="modal fade import-study-data import-window" id="importStudyModal" role="dialog" aria-labelledby="importStudyModal" aria-hidden="true">
			<div class="modal-dialog modal-medium">
				<div class="modal-content">

					<div class="modal-body" id="importStudyModalBody">
						<div class="row form-group">
							<div class="col-xs-11 col-md-11">
								<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{study.import.select.header}"></label>
							</div>
							<div class="col-xs-1 col-md-1">
								<button id="close" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
							</div>
						</div>

						<div class="row form-group">
							<div id="page-import-study-message-modal" class="col-xs-12 col-md-12">
							</div>
						</div>

						<div class="row form-group">
							<div class="col-xs-12 col-md-12">
								<label class=""><em th:utext="#{fieldmap.mandatory.fields}"> Mandatory fields are noted with a *</em></label>
							</div>
						</div>

						<div class="row form-group">
							<div class="col-xs-7 col-md-7">
								<label th:text="#{study.import.specify.format}" class="control-label add_top_padding label-bold"></label><span class="required">*</span>
							</div>
							<div class="col-xs-5 col-md-5">
								<select style="width: 205px" id="importType">
									<option value="0">Please Choose</option>
									<option value="7" th:text="#{nursery.import.csv}"></option>
									<option value="4" th:text="#{nursery.import.datakapture}"></option>
									<option selected="selected" value="3" th:text="#{nursery.import.excel}"></option>
									<option value="1" th:text="#{nursery.import.fieldlog.fieldroid}"></option>
									<option value="5" th:text="#{nursery.import.ksu.fieldbook.excel}"></option>
									<option value="6" th:text="#{nursery.import.ksu.fieldbook.csv}"></option>
								</select>
							</div>
						</div>

						<div class='row form-group add_top_padding'>

							<div class="col-md-12">
								<div class="fileupload fileupload-new fbk-import-upload-file" data-provides="fileupload">
											<span class="btn btn-info btn-file ">
												<span class="fileupload-new" th:text="#{nursery.import.germplasm.browse.file}">Browse</span>
												<input id="fileupload" th:field="*{file}" type="file" class="file-input"/>
											</span>
									<span class="fileupload-preview-wrap"><b><span th:text="#{selected.import.file}">Selected import file</span>:</b> <i class="fileupload-preview"></i></span>
									<span style="display: inline-block; margin-left: 15px">
										<a href="#" class="btn btn-default fileupload-exists" data-dismiss="fileupload" th:text="#{nursery.managesettings.clear.settings}">Clear</a>
									</span>

								</div>
							</div>
						</div>
					</div>

					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}">Cancel</button>
						<button type="button" class="btn btn-primary" aria-hidden="true" onclick="javascript:submitImportStudy();">Import</button>
					</div>
				</div>
			</div>
		</div>
	</form>
</div>

<div class="modal fade import-window" id="importStudyConfirmationModal" role="dialog" aria-labelledby="importStudyConfirmationModal" aria-hidden="true">
	<div class="modal-dialog modal-small">
		<div class="modal-content">
			<div class="modal-body" id="importStudyConfirmationModalBody">
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">
						<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{common.form.confirmation.text}"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						&nbsp;
					</div>
				</div>
				<div class="row form-group">
					<div class="col-xs-12 col-md-12">
						<label class="control-label import-confirmation"></label>
					</div>
				</div>


				<div class="modal-footer">
					<button type="button" class="btn btn-default"  onclick="javascript:goBackToImport();" th:text="#{nursery.go.back}">Cancel</button>
					<button type="button" class="btn btn-primary"  id="studyConfirmationButton" th:text="#{nursery.proceed}">Import</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade import-window" id="importStudyDesigConfirmationModal" role="dialog" aria-labelledby="importStudyDesigConfirmationModal" aria-hidden="true">
	<div class="modal-dialog modal-medium">
		<div class="modal-content">
			<div class="modal-body" id="importStudyDesigConfirmationModalBody">
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">
						<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{common.form.confirmation.text}"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						&nbsp;
					</div>
				</div>
				<div class="row form-group">
					<div id="confirmation-page-message">
					</div>
				</div>
				<div class="row form-group">
					<div class="col-xs-12 col-md-12">
						<label class="control-label import-desig-confirmation label-bold"></label>
					</div>
				</div>

				<div class="row form-group">
					<div class="col-xs-4 col-md-4">
						<label class="control-label label-bold" th:text="#{import.change.action} + ':'">Action:</label>
					</div>
					<div class="col-xs-7 col-md-7">
						<select id="import-action-type" onchange="doImportActionChange();">
							<option value="0" th:text="#{import.change.option.skip}">Skip</option>
							<option value="1" th:text="#{import.change.option.add.desig.to.gid}">Add the New Designation to the Germplasm</option>
							<option value="2" th:text="#{import.change.option.create.new.desig}">Create a New Germplasm</option>
							<option value="3" th:text="#{import.change.option.choose.gids}" class="choose-gids">Choose GIDs</option>
						</select>
					</div>
				</div>

				<div class="row form-group choose-gids">
					<div class="col-xs-4 col-md-4">
						<label class="control-label label-bold" th:text="#{import.change.option.choose.gids} + ':'">Choose GIDs:</label>
					</div>
					<div class="col-xs-7 col-md-7">
						<select style="width: 205px" id="matching-gid">
						</select>
					</div>
				</div>

				<form id="importStudyConfirmationForm" method="post" th:object="${createNurseryForm}" enctype="multipart/form-data">
					<input type="hidden" class="hasCreateGermplasm" />
					<div class="row form-group create-germplasm add-desig-to-gid">
						<div class="col-xs-4 col-md-4">
							<label class="control-label label-bold" th:text="#{nursery.import.excel.breeding.method}+':'">Breeding Method</label>&nbsp;<span class="required">*</span>
						</div>
						<div class="col-xs-8 col-md-8">
							<input class="selectedValue" type="hidden" />
							<input class="selectedValueFave" type="hidden" />
							<input type="hidden" th:field="*{importMethodId}" class="form-control select2" />
							<div style="width: 100%" class="possibleValuesDiv">
							        <label class="radio-inline">
										<input id="showDerivateAndMaintenanceMethodImportStudyOnlyRadio" th:onclick="'javascript: toggleDropdownImportStudy(\'showAllMethodImportStudyOnlyRadio\', \'importMethodId\', \'importFavoriteMethod\', \'Method\', false);'" name="import_study_method_filter" value="1" type="radio" checked="checked" />
                                        <span th:text="#{show.derivative.maintenance.method}">Derivative and Maintenance methods</span>
                                        &nbsp;&nbsp;
                                    </label>
                                    <label class="radio-inline">
										<input id="showAllMethodImportStudyOnlyRadio" th:onclick="'javascript: toggleDropdownImportStudy(\'showAllMethodImportStudyOnlyRadio\', \'importMethodId\', \'importFavoriteMethod\', \'Method\', false);'" name="import_study_method_filter" value="2" type="radio" />
                                        <span th:text="#{show.all.methods}">All Methods</span>
                                        &nbsp;&nbsp;
                                    </label>
							</div>
							<div style="width: 100%" class="possibleValuesDiv">
									<input type="checkbox" th:onclick="'javascript: toggleDropdownImportStudy(\'showAllMethodImportStudyOnlyRadio\', \'importMethodId\', \'importFavoriteMethod\', \'Method\', false);'" id="importFavoriteMethod"/>
									&nbsp;&nbsp;
									<span th:text="#{show.favorite.method}">Show Favorite Method</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									<a class='import-manage-method' href="javascript: void(0)" th:text="#{nursery.managesettings.manage.method}">Manage Method</a>
							</div>
							<!-- store possible values of variable -->
							<div id="possibleValuesJsonMethod"
								class="possibleValuesJsonMethod" style="display:none">
							</div>
							<div id="possibleValuesFavoriteJsonMethod"
								class="possibleValuesFavoriteJsonMethod" style="display:none">
							</div>
							<!-- all values -->
							<div id="allPossibleValuesJsonMethod"
								 class="allPossibleValuesJsonMethod" style="display:none">
							</div>
							<!-- all favorite values -->
							<div id="allPossibleValuesFavoriteJsonMethod"
								 class="allPossibleValuesFavoriteJsonMethod" style="display:none">
							</div>
						</div>
					</div>
					<div class="row form-group create-germplasm">
						<div class="col-xs-4 col-md-4">
							<label class="control-label label-bold" th:text="#{nursery.import.excel.date}+':'">Date</label>&nbsp;<span class="required">*</span>
						</div>
						<div class="col-xs-7 col-md-7">
							<input placeholder="yyyy-mm-dd" type="text" class="form-control date-input" th:field="*{importDate}" />
							<label for="importDate" class="btn datepicker">
								<img width="20" height="22" th:src="@{/static/img/calendar.png}" style="padding-bottom:3px;" />
							</label>
						</div>
					</div>
					<div class="row form-group create-germplasm">
						<div class="col-xs-4 col-md-4">
							<label class="control-label label-bold" th:text="#{nursery.import.excel.location}+':'">Location</label>&nbsp;<span class="required">*</span>
						</div>
						<div class="col-xs-8 col-md-8">
							<input class="selectedValue" type="hidden" />
							<input class="selectedValueFave" type="hidden" />
							<input type="hidden" th:field="*{importLocationId}" class="form-control select2" />

							<div style="width: 100%" class="possibleValuesDiv">
									<label class="radio-inline">
											<input id="showBreedingLocationImportStudyOnlyRadio" th:onclick="'javascript: toggleDropdownImportStudy(\'showAllLocationImportStudyOnlyRadio\', \'importLocationId\', \'importFavoriteLocation\', \'Location\', true);'" name="import_study_location_filter" value="1" type="radio" checked="checked" /> <span th:text="#{show.breeding.location}">Breeding locations</span>
                                        &nbsp;&nbsp;
                                    </label>
                                    <label class="radio-inline">
											<input id="showAllLocationImportStudyOnlyRadio" th:onclick="'javascript: toggleDropdownImportStudy(\'showAllLocationImportStudyOnlyRadio\', \'importLocationId\', \'importFavoriteLocation\', \'Location\', true);'" name="import_study_location_filter" value="2" type="radio" /> <span th:text="#{show.all.location}">All locations types</span>
                                        &nbsp;&nbsp;
                                    </label>
                            </div>
                            <div style="width: 100%" class="possibleValuesDiv">
										<input type="checkbox" th:onclick="'javascript: toggleDropdownImportStudy(\'showAllLocationImportStudyOnlyRadio\', \'importLocationId\', \'importFavoriteLocation\', \'Location\', true);'" id="importFavoriteLocation"/>
									&nbsp;&nbsp;
									<span th:text="#{show.favorite.location}">Show Favorite Location</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
									<a class='import-manage-location' href="javascript: void(0)"  th:text="#{nursery.managesettings.manage.location}">Manage Location</a>
							</div>
							<!-- store possible values of variable -->
							<div id="possibleValuesJsonLocation"
								class="possibleValuesJsonLocation" style="display:none">
							</div>
							<div id="possibleValuesFavoriteJsonLocation"
								class="possibleValuesFavoriteJsonLocation" style="display:none">
							</div>
							<!-- all values -->
							<div id="allPossibleValuesJsonLocation"
								 class="allPossibleValuesJsonLocation" style="display:none">
							</div>
							<!-- all favorite values -->
							<div id="allPossibleValuesFavoriteJsonLocation"
								 class="allPossibleValuesFavoriteJsonLocation" style="display:none">
							</div>
						</div>
					</div>
					<div class="row form-group create-germplasm">
						<div class="col-xs-4 col-md-4">
							<label class="control-label label-bold" th:text="#{nursery.import.excel.name.type}+':'">Name Type</label>&nbsp;<span class="required">*</span>
						</div>
						<div class="col-xs-7 col-md-7">
							<select th:field="*{nameType}">
								<option th:value="${nameType.fldno}" th:text="${nameType.fname}" th:each="nameType : ${nameTypes}"> </option>
							</select>
						</div>
					</div>
				</form>
				<div class="row form-group no-choose-gids">
					<div class="col-xs-12 col-md-12">
						<input type="checkbox" id="yesToAllDesig" name="yesToAllDesig" value="1"/>
						<label class="control-label" th:text="#{apply.to.all}">Accept All Changes</label>
					</div>
				</div>

				<div class="modal-footer">
					<button type="button" class="btn btn-default"  onclick="javascript:goBackToImport();" th:text="#{common.form.cancel.text}" >Cancel</button>
					<button type="button" class="btn btn-primary"  onclick="javascript:confirmDesignation();" th:text="#{common.form.yes.text}">Yes</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade import-window" id="discardImportDataConfirmation" role="dialog" aria-labelledby="discardImportDataConfirmation" aria-hidden="true">
	<div class="modal-dialog modal-small">
		<div class="modal-content">
			<div class="modal-body" id="discardImportDataConfirmationBody">
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">
						<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{common.form.confirmation.text}"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						<button id="close" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
					</div>
				</div>
				<div class="row form-group">
					<div class="col-xs-12 col-md-12">
						<label class="control-label label-bold" th:text="#{import.data.discard.confirmation}">Do you really want to discard your imported data?</label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal"  th:text="#{common.form.no.text}">Cancel</button>
					<button type="button" class="btn btn-primary"  onclick="javascript:revertData(true);" th:text="#{common.form.yes.text}">Import</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade import-window" id="discardImportStockListDataConfirmation" role="dialog" aria-labelledby="discardImportDataConfirmation" aria-hidden="true">
	<div class="modal-dialog modal-small">
		<div class="modal-content">
			<div class="modal-body" id="discardImportStockListDataConfirmationBody">
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">
						<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{common.form.confirmation.text}"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						<button id="close" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
					</div>
				</div>
				<div class="row form-group">
					<div class="col-xs-12 col-md-12">
						<label class="control-label label-bold" th:text="#{import.data.discard.confirmation}">Do you really want to discard your imported data?</label>
					</div>
				</div>


				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal"  th:text="#{common.form.no.text}">Cancel</button>
					<button type="button" class="btn btn-primary"  onclick="javascript:revertStockListData(true);" th:text="#{common.form.yes.text}">Import</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="modal fade import-window" id="importOverwriteConfirmation" role="dialog" aria-labelledby="importOverwriteConfirmation" aria-hidden="true">
	<div class="modal-dialog modal-small">
		<div class="modal-content">
			<div class="modal-body" id="importOverwriteConfirmationBody">
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">
						<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{common.form.confirmation.text}"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						<button id="close" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
					</div>
				</div>
				<div class="row form-group">
					<div class="col-xs-12 col-md-12">
						<label class="control-label label-bold" th:text="#{import.data.overwrite.confirmation}">Current import file will overwrite existing data, do you want to continue?</label>
					</div>
				</div>


				<div class="modal-footer">
					<button type="button" class="btn btn-default"  data-dismiss="modal"   th:text="#{common.form.no.text}">No</button>
					<button type="button" class="btn btn-primary"  onclick="continueStudyImport(true);" th:text="#{common.form.yes.text}">Yes</button>
				</div>
			</div>
		</div>
	</div>
</div>

<div layout:fragment="page-script">
	<script type="text/javascript" th:src="@{/static/js/lib/bootstrap/bootstrap-fileupload.js}"></script>
<script type='text/javascript' th:inline="javascript">
//<![CDATA[
/*globals displaySaveSuccessMessage, createTableSettingVariables, importNursery, Spinner, showErrorMessage*/
/*globals recreateMethodCombo,showErrorMessage,showImportResponse,recreateLocationCombo*/
/*exported showImportResponse, importOptions, confirmDesignation, goBackToImport, doImportActionChange*/
/*exported importStudyBookHeader, importStudyHeader*/

var importStudyHeader = /*[[#{study.import.study.header}]]*/ '',
	importStudyBookHeader = /*[[#{study.import.study.book.header}]]*/ '',
	changeConfirmationDetails = [],
	currentConfirmationIndex = 0,
	saveImportSuccessMessage = /*[[#{import.save.confirmation.text}]]*/ '',
	importOptions = {
		dataType: 'text',
		success: showImportResponse // post-submit callback
	};

$(document).ready(function() {
	'use strict';
	$('.import-window select').select2({width: 'copy', minimumResultsForSearch: 20});
	$('#importType').on('change', function() {
		if ($(this).val() !== '0') {
			importNursery($(this).val());
		}
	});

	$('#importStudyModal').on('hide.bs.modal', function() {
		$('div.fileupload').parent().parent().removeClass('has-error');
		$('#importStudyModal .fileupload-exists').click();
	});

	$('#importStudyDesigConfirmationModal').on('hide.bs.modal', function() {
		$('input[type=checkbox][name=yesToAllDesig]').prop('checked', false);
	});

	//set to 1 to initialize only the location and method dropdowns in the import modal
	$('.hasCreateGermplasm').val(1);
	recreateMethodCombo('importFavoriteMethod');
	recreateLocationCombo('importFavoriteLocation');
	$('.hasCreateGermplasm').val(0);

	$('#importDate').each(function() {
		$(this).datepicker({'format': 'yyyy-mm-dd'}).on('change', function(e) {
			var curDate = $(this).val();
			try {
				var r = $.datepicker.parseDate('yy-mm-dd', curDate);
				$(this).datepicker('setDate', r);
			} catch (e) {
				$(this).datepicker('setDate', new Date());
			}
		}).on('changeDate', function(ev) {
			$(this).datepicker('hide');

		}).on('show', function() {
			$('input[type=checkbox][name=yesToAllDesig]').data('is-checked', $('input[type=checkbox][name=yesToAllDesig]').prop('checked'));
		}).on('hide', function() {
			setTimeout(function() {$('input[type=checkbox][name=yesToAllDesig]').prop('checked', $('input[type=checkbox][name=yesToAllDesig]').data('is-checked'));}, 5);
		});
	});
	$('#importType').change();

	$('.import-manage-location').on('click', function() {
		$('#importStudyDesigConfirmationModal').modal('hide');
		$('#importStudyDesigConfirmationModal').data('open', '1');
		setTimeout(openManageLocations, 500);
	});

	$('.import-manage-method').on('click', function() {
		$('#importStudyDesigConfirmationModal').modal('hide');
		$('#importStudyDesigConfirmationModal').data('open', '1');
		setTimeout(openManageMethods, 500);
	});
	$('#importStudyDesigConfirmationModal').data('open', '0');

	$(document).off('location-update');
	$(document).on('location-update', recreateLocationCombo);
});
function doRefreshNurserySettings() {
	'use strict';
	$.ajax({
		url: '/Fieldbook/NurseryManager/createNursery/refresh/settings/tab',
		type: 'GET',
		cache: false,
		async: false,
		success: function(data) {
			$('#chooseSettingsDiv').html(data);
			displaySaveSuccessMessage('page-message', saveImportSuccessMessage);
		}
	});
}
function doSaveImportedData() {
	'use strict';
	var columnsOrder = BMS.Fieldbook.MeasurementsTable.getColumnOrdering('measurement-table');
	var serializedData = 'columnOrders=' + encodeURIComponent(JSON.stringify(columnsOrder));
	return $.ajax({
		url: '/Fieldbook/ImportManager/import/save',
		type: 'POST',
		data: serializedData,
		async: true,
		success: function(html) {
			//$('#measurementsDiv').html(html);

			$('.import-study-data').data('data-import', '0');
			$('.import-study-data').data('measurement-show-already', '0');
			$('.fbk-discard-imported-data').addClass('fbk-hide');

			$('body').trigger({
				type: 'REFRESH_AFTER_IMPORT_SAVE'
			});

			if (isNursery()) {
				doRefreshNurserySettings();
				updateMeasurementDataExistingValue(!hasMeasurementData());
				displayEditFactorsAndGermplasmSection();
			} else {
				displaySaveSuccessMessage('page-message', saveImportSuccessMessage);
			}
			reloadMeasurementTable();
		}
	});
}
function doMeasurementsReload(hasDataOverwrite) {
	'use strict';
	$('.import-study-data').data('data-import', '1');
	$.ajax({
		url: '/Fieldbook/ImportManager/import/preview',
		type: 'POST',
		success: function(html) {
			$('#measurementsDiv').html(html);
			$('.fbk-discard-imported-data').removeClass('fbk-hide');
			if (hasDataOverwrite === '1') {
				showAlertMessage('', importSuccessOverwriteDataWarningToSaveMessage, 5000);
			} else {
				showSuccessfulMessage('', importSuccessReminderToSaveMessage);
			}
		}
	});

	$('#importStudyModal').modal('hide');
	$('#importStudyConfirmationModal').modal('hide');
	$('#importOverwriteConfirmation').modal('hide');
	return false;
}
function confirmStudyImport(hasDataOverwrite) {
	'use strict';
	if (changeConfirmationDetails.length !== 0) {
		showDesigConfirmation(hasDataOverwrite);
	} else {
		doMeasurementsReload(hasDataOverwrite);
	}
}

function showImportResponse(responseText) {
//reload the screen
	'use strict';
  	var resp = $.parseJSON(responseText);
  	changeConfirmationDetails = [];
  	currentConfirmationIndex = 0;
  	if (resp.changeDetails != null && resp.changeDetails.length !== 0) {
   		for (var index = 0; index < resp.changeDetails.length; index++) {
      	changeConfirmationDetails.push(resp.changeDetails[index]);
    	}

	}
	if (resp.isSuccess === 1) {
    	if (resp.conditionConstantsImportErrorMessage !== null && resp.conditionConstantsImportErrorMessage !== '') {
      	showAlertMessage('', resp.conditionConstantsImportErrorMessage);
    	}

    	$('#importStudyModal').modal('hide');
    	if (resp.deletedTraits !== ' ' || resp.addedTraits !== ' ') {
			showWarningTraitsImport(resp);
    	} else {
			showWarningImport(resp);
    	}
	} else {
		showErrorMessage('page-import-study-message-modal', resp.error);
		$('#importStudyModal').modal('hide');
	}
}

function showWarningTraitsImport(resp) {
	'use strict';
	setTimeout(function() {
	$('#importStudyConfirmationModal').modal({
	      backdrop: 'static',
	      keyboard: true
	    });
	  }, 300);
	var warningTraitsMessage = '', errorIndex = 0;
	warningTraitsMessage = resp.confirmMessageTrais;

	warningTraitsMessage += '<p> </p>';
	warningTraitsMessage += '<ul>';

	if (resp.deletedTraits !== ' ') {
		warningTraitsMessage += '<li>';
		warningTraitsMessage += '<b>' + 'Missing traits: ' + '</b>';
		warningTraitsMessage += resp.deletedTraits + ' in the nursery are not present in the file.';
		warningTraitsMessage += '</li>';
		warningTraitsMessage += '<p>' + '</p>';
	}

	if (resp.addedTraits !== ' ') {
		warningTraitsMessage += '<li>';
		warningTraitsMessage += '<b>' + 'Additional traits: ' + '</b>';
		warningTraitsMessage += 'the file contains the trait(s) ' + resp.addedTraits + ', that are not present in the nursery. ';
		warningTraitsMessage += 'This data will be discarded. if you wish to import additional traits, please add them to the nursery before ';
		warningTraitsMessage += 'importing the data file.';
		warningTraitsMessage += '</li>';
	}

	warningTraitsMessage += '</ul>';
	warningTraitsMessage += '<br />';

	$('#importStudyConfirmationModal .import-confirmation').html(warningTraitsMessage);
	$('#studyConfirmationButton').off('click');
	$('#studyConfirmationButton').on('click', function() {
	    showWarningImport(resp);
	})

}

function showWarningImport(resp) {
	'use strict';
	if (resp.hasDataOverwrite === '1') {
		  setTimeout(function() {
		    $('#importStudyConfirmationModal').modal({
		      backdrop: 'static',
		      keyboard: true
		    });
		  }, 300);
		var confirmMessage = '', errorIndex = 0;
	
		confirmMessage = resp.message;
		confirmMessage += '<p> </p>';
		confirmMessage += resp.confirmMessage;
		$('#importStudyConfirmationModal .import-confirmation').html(confirmMessage);
		$('#studyConfirmationButton').off('click');
		$('#studyConfirmationButton').on('click', function() {
		    confirmStudyImport('0');
		})
	}else{
		confirmStudyImport('0');
	}
}

function applyChangeDetails() {
	'use strict';
	var data = JSON.stringify(changeConfirmationDetails);
	$.ajax({
		url: '/Fieldbook/ImportManager/apply/change/details',
		type: 'POST',
		data: 'data=' + data,
		success: function() {
			$('#importStudyDesigConfirmationModal').modal('hide');
			doMeasurementsReload('0');
		}
	});
}

function showDesignationConfirmationMessage() {
	'use strict';
	$('#import-action-type option:selected').prop('selected', false);
	$('#import-action-type option[value=0]').prop('selected', true);
	$('#import-action-type').change();
	$('input[type=checkbox][name=yesToAllDesig]').prop('checked', false);
	$('#matching-gid').empty();
	$('#matching-gid').change();
	$('#importStudyDesigConfirmationModal .import-desig-confirmation').html(changeConfirmationDetails[currentConfirmationIndex].message);
	if (changeConfirmationDetails[currentConfirmationIndex].matchingGids && changeConfirmationDetails[currentConfirmationIndex].matchingGids.length > 0) {
		for (var i = 0; i < changeConfirmationDetails[currentConfirmationIndex].matchingGids.length; i++) {
			$('#matching-gid').append(
					new Option(changeConfirmationDetails[currentConfirmationIndex].matchingGids[i],
							changeConfirmationDetails[currentConfirmationIndex].matchingGids[i]));
		}
		$('#matching-gid').change();

		$('#import-action-type option[value=3]').prop('disabled', false);
		if ($('#import-action-type').val() === '3') {
			$('.choose-gids').show();
			$('.no-choose-gids').hide();
		} else {
			$('.choose-gids').hide();
			$('.no-choose-gisd').show();
		}
	} else {
		$('#import-action-type option[value=3]').prop('disabled', true);
		$('.choose-gids').hide();
		$('.no-choose-gids').show();
	}
	//we do the reset here
	resetDesigConfirmationFields();
}

function showDesigConfirmation(hasDataOverwrite) {
	'use strict';
	if (hasDataOverwrite === '1') {
		showAlertMessage('', importSuccessOverwriteDataWarningToSaveMessage, 5000);
	}

	$('#importStudyModal').modal('hide');
	$('#importStudyConfirmationModal').modal('hide');
	$('#importOverwriteConfirmation').modal('hide');
	setTimeout(function() {$('#importStudyDesigConfirmationModal').modal({ backdrop: 'static', keyboard: true });}, 300);
	resetDesigConfirmationFields();
	showDesignationConfirmationMessage();
}

function confirmDesignation() {
	'use strict';
	var status = $('#import-action-type').val(),
		applyDetails = false,
		importDate = $('#importDate').val(),
		nameType = $('#nameType').select2('data').id,
		importLocationId = $('#importLocationId').select2('data') === null ? null : $('#importLocationId').select2('data').id,
		importMethodId = $('#importMethodId').select2('data') === null ? null : $('#importMethodId').select2('data').id;

	if (validateGermplasmInput(importDate, importLocationId, importMethodId)) {
		if ($('input[type=checkbox][name=yesToAllDesig]:checked').val() === '1') {
			for (var index = currentConfirmationIndex ; index < changeConfirmationDetails.length ; index++) {
				changeConfirmationDetails[index].status = status;
				changeConfirmationDetails[index].importDate = importDate;
				changeConfirmationDetails[index].nameType = nameType;
				changeConfirmationDetails[index].importLocationId = importLocationId;
				changeConfirmationDetails[index].importMethodId = importMethodId;
			}
			applyDetails = true;
		} else {
			changeConfirmationDetails[currentConfirmationIndex].status = status;
			changeConfirmationDetails[currentConfirmationIndex].importDate = importDate;
			changeConfirmationDetails[currentConfirmationIndex].nameType = nameType;
			changeConfirmationDetails[currentConfirmationIndex].importLocationId = importLocationId;
			changeConfirmationDetails[currentConfirmationIndex].importMethodId = importMethodId;
			changeConfirmationDetails[currentConfirmationIndex].selectedGid = $('#matching-gid').val();
			currentConfirmationIndex++;
			if (currentConfirmationIndex === changeConfirmationDetails.length) {
				//meaning we've gone through all the confirmation
				applyDetails = true;
			} else {
				showDesignationConfirmationMessage();
			}

		}
		if (applyDetails) {
			applyChangeDetails();
		}
	}
}

function saveStockListImport(){
	showSuccessfulMessage('', 'Imported data successfully saved.');
	$('.fbk-save-nursery').removeClass('fbk-hide');
	$('.fbk-save-stocklist').addClass('fbk-hide');
	$('.fbk-discard-imported-stocklist-data').addClass('fbk-hide');
	stockListImportNotSaved = false;
}

function revertStockListData(){
	'use strict';
	var revertUrl = '/Fieldbook/stock/revertStockListData/data';
	$.ajax({
		url: revertUrl,
		type: 'POST',
		data: '',
		cache: false,
		success: function(resp) {
			showSuccessfulMessage('', 'Imported data successfully discarded.');
			$('.fbk-save-nursery').removeClass('fbk-hide');
			$('.fbk-save-stocklist').addClass('fbk-hide');
			$('.fbk-discard-imported-stocklist-data').addClass('fbk-hide');
			$('#discardImportStockListDataConfirmation').modal('hide');
			$('.import-study-data').data('data-import', '0');
			var response = JSON.parse(resp);
			StockIDFunctions.displayStockList(response.stockListId);
			stockListImportNotSaved = false;
		}
	});
}
function revertData(showMessage) {
	'use strict';
	var revertUrl = '/Fieldbook/ImportManager/revert/data';
	$.ajax({
		url: revertUrl,
		type: 'GET',
		data: '',
		cache: false,
		async: false,
		success: function(html) {
			$('#measurementsDiv').html(html);
			if (showMessage === true) {
				showSuccessfulMessage('', 'Discarded imported data successfully');
			}
			$('.fbk-discard-imported-data').addClass('fbk-hide');
			$('#discardImportDataConfirmation').modal('hide');
			$('.import-study-data').data('data-import', '0');
		}
	});
}

function doImportActionChange() {
	'use strict';
	if ($('#import-action-type').val() === '3') {
		$('.choose-gids').show();
		$('.no-choose-gids').hide();
		$('.create-germplasm').hide();
		$('input[type=checkbox][name=yesToAllDesig]').prop('checked', false);
	} else if ($('#import-action-type').val() === '2') {
		$('.create-germplasm').show();
		$('.no-choose-gids').show();
		$('.choose-gids').hide();
	} else if ($('#import-action-type').val() === '1') {
		$('.create-germplasm').show();
		$('.add-desig-to-gid').hide();
		$('.no-choose-gids').show();
		$('.choose-gids').hide();
	} else {
		$('.choose-gids').hide();
		$('.create-germplasm').hide();
		$('.no-choose-gids').show();
		$('#matching-gid').empty();
		$('#matching-gid').change();
	}
}
//]]>
</script>
</div>
