<div class="col-xs-10 col-md-10" xmlns:th="http://www.thymeleaf.org">
	<form onsubmit="javascript: return validateAdvanceNursery();" id="advanceNurseryModalForm" role="form-horizontal" action="#" th:action="@{/NurseryManager/advance/nursery}" method="post" th:object="${advancingNurseryform}" enctype="multipart/form-data">

		<input type="hidden" th:field="*{locationUrl}"/>
		<input type="hidden" th:field="*{breedingMethodUrl}"/>
		<input type="hidden" th:field="*{defaultMethodId}"/>
		<input type="hidden" th:field="*{nurseryId}"/>
		<input type="hidden" th:field="*{harvestDate}"/>

		<div class="modal fade" id="advanceNurseryModal" role="dialog" aria-labelledby="advanceNurseryModal" aria-hidden="true">
			<div class="modal-dialog modal-large">
				<div class="modal-content">					
					<div class="modal-body">
						<div class="row form-group">
							<div class="col-xs-11 col-md-11">					
								<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{nursery.nurserydetails.action.advance}"></label>
							</div>
							<div class="col-xs-1 col-md-1">
								<button  id="closeAdvanceNurseryModal" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
							</div>										
						</div>
						
						<div class="row">
							<div class="form-group">
								<div id="page-advance-modal-message"></div>
							</div>
						</div>						

						<div class="row form-group">
							<div class="col-xs-12 col-md-12" >
								<label class=""><em th:utext="#{fieldmap.mandatory.fields}"> Mandatory fields are noted with a *</em></label>
							</div>
						</div>
						<br/>
						<div class="row form-group col-xs-12 col-md-12" id="methods-section">
							<div class="row form-group col-xs-12 col-md-12">
								<label class="control-label">
									<strong class="sub-content-heading" th:text="#{advancing.nursery.method}">METHODS</strong>
								</label>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
								<label class="control-label">
									<input type="checkbox" th:field="*{methodChoice}" th:value="*{methodChoice}"/>
									<span class="label-bold" th:text="#{advancing.nursery.breeding.method.the.same}">
										Breeding Method is the same for each advance
									</span>
								</label>
							</div>
							<div class="row form-group col-xs-6 col-md-6 method-selection-div">
								<div class="row form-group col-xs-11 col-md-11 method-selection-div">
									<input type="hidden" th:field="*{methodIdAll}" class="form-control select2 non-maize-control" placeholder=""/>
									<input type="hidden" th:field="*{methodIdFavorite}" class="form-control select2 non-maize-control" placeholder=""/>
									<input type="hidden" th:field="*{advanceBreedingMethodId}"/>
								</div>
								<div class="col-xs-1 col-md-1 method-selection-div help-tooltip-col">
									<span data-container="#advanceNurseryModal .modal-body" id="method-tooltip" class="bms-fa-question-circle help-tooltip-nursery help-tooltip-nursery-advance" data-placement="top" data-toggle="tooltip" style="display:inline;"></span>
								</div>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
							</div>
							<div class="row form-group col-xs-6 col-md-6 method-selection-div">
								<label class="non-maize-control">
									<input id="showFavoriteMethod" value="1" type="checkbox"/> <span th:text="#{show.favorite.method}">Show Favorite Method</span>
									&nbsp;&nbsp;
									<a class="form-group" href="javascript: openManageMethods()" th:text="#{advancing.nursery.manage.method}">Manage Methods</a>
								</label>
							</div>
							<div id="method-variates-section">
								<div class="row form-group col-xs-6 col-md-6">
									<label class="control-label label-bold" th:text="#{advancing.nursery.method.variate} + ':'">Choose a variate that defines the breeding method for each advance:</label>
								</div>
								<div class="row form-group col-xs-6 col-md-6">
									<select th:field="*{methodVariateId}">
										<option th:each="methodVariate : *{methodVariates}" th:value="${methodVariate.id}" th:text="${methodVariate.name}">
										</option>
									</select>
								</div>
							</div>
						</div>

						<br/>
						<div class="row form-group col-xs-12 col-md-12 lines-section">
							<div class="row form-group col-xs-12 col-md-12">
								<label class="control-label" ><strong class="sub-content-heading" th:text="#{advancing.nursery.lines}">LINES</strong> </label>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
								<label class="control-label">
									<input type="checkbox" th:field="*{lineChoice}" th:value="*{lineChoice}"/>
									<span class="label-bold" th:text="#{advancing.nursery.line.the.same}">Same number of lines is selected for each plot</span>
								</label>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
							</div>
						</div>
						<div class="row form-group col-xs-12 col-md-12 lines-section">
							<div class="row form-group col-xs-6 col-md-6 lines-per-plot-section">
								<label class="control-label label-bold" th:text="#{advancing.nursery.number.of.samples.plot} + ':'">Lines Selected per Plot:</label>
							</div>
							<div class="row form-group col-xs-6 col-md-6 lines-per-plot-section">
								<input class="form-control" type="text" th:field="*{lineSelected}"/>
							</div>
							<div id="line-variates-section">
								<div class="row form-group col-xs-6 col-md-6">
									<label class="control-label label-bold" th:text="#{advancing.nursery.lines.variate}"></label>
								</div>
								<div class="row form-group col-xs-6 col-md-6">
									<select th:field="*{lineVariateId}" class="ps-variate-selection">
										<option th:each="lineVariate : *{lineVariates}" th:value="${lineVariate.id}" th:text="${lineVariate.name}">
										</option>
									</select>
								</div>
							</div>
						</div>
						<br/>
						<div class="row form-group col-xs-12 col-md-12 bulk-section">
							<div class="row form-group col-xs-12 col-md-12">
								<label class="control-label" ><strong class="sub-content-heading" th:text="#{advancing.nursery.bulks}">BULKS</strong> </label>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
								<label class="control-label">
									<input type="checkbox" th:field="*{allPlotsChoice}" th:value="*{allPlotsChoice}" />
									<span class="label-bold" th:text="#{advancing.nursery.all.plots.selected}">All plots are selected</span>
								</label>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
							</div>
						</div>
						<div class="row form-group col-xs-12 col-md-12 bulk-section">
							<div id="plot-variates-section">
								<div class="row form-group col-xs-6 col-md-6">
									<label class="control-label label-bold" th:text="#{advancing.nursery.bulks.variate}"></label>
								</div>
								<div class="row form-group col-xs-6 col-md-6">
									<select th:field="*{plotVariateId}">
										<option th:each="plotVariate : *{plotVariates}" th:value="${plotVariate.id}" th:text="${plotVariate.name}">
										</option>
									</select>
								</div>
							</div>
						</div>
						<br/>
						<div class="row form-group col-xs-12 col-md-12">
							<div class="row form-group col-xs-12 col-md-12">
								<label class="control-label" ><strong class="sub-content-heading" th:text="#{advancing.nursery.harvest.information}">Harvest Details</strong> </label>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
								<label class="control-label label-bold" th:text="#{advancing.nursery.harvest.location}">Harvest Location:</label><span class="required"></span>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
								<div class="row form-group col-xs-11 col-md-11">
									<input type="hidden" th:field="*{harvestLocationIdAll}" class="form-control select2" placeholder=""/>
									<input type="hidden" th:field="*{harvestLocationIdFavorite}" class="form-control select2" placeholder=""/>
									<input type="hidden" th:field="*{harvestLocationId}"/>
									<input type="hidden" th:field="*{harvestLocationName}" />
									<input type="hidden" th:field="*{harvestLocationAbbreviation}" />
								</div>
								<div class="col-xs-1 col-md-1 help-tooltip-col">
									<span data-container="#advanceNurseryModal .modal-body" id="harvestloc-tooltip" class="bms-fa-question-circle help-tooltip-nursery help-tooltip-nursery-advance" data-placement="top" data-toggle="tooltip"></span>
								</div>
							</div>
							<div class="row form-group col-xs-6 col-md-6">
							</div>
							<div class="row col-xs-6 col-md-6 form-group">
								<label>
									<input id="showFavoriteLocation" value="1" type="checkbox"/> <span th:text="#{show.favorite.location}">Show Favorite Location</span>
									&nbsp;&nbsp;
									<a href="javascript: openManageLocations()" th:text="#{advancing.nursery.manage.location}">Manage Locations</a>
								</label>
							</div>

						</div>
						<div class="row form-group col-xs-12 col-md-12">
							<div class="row form-group col-xs-6 col-md-6">
								<label for="harvestDate" class="control-label label-bold" th:text="#{advancing.nursery.harvest.date}">Harvest Date</label><span class="required"></span>
							</div>
							<div class="row col-xs-2 col-md-2 form-group">
								<select th:field="*{harvestYear}" style="width: 100px">
									<option th:each="year : ${yearChoices}" th:value="${year.val}" th:text="${year.name}">
									</option>
								</select>
							</div>
							<div class="row col-xs-1 col-md-1 form-group">
								<select th:field="*{harvestMonth}" style="width: 100px">
									<option th:each="month : ${monthChoices}" th:value="${month.val}" th:text="${month.name}"></option>
								</select>
							</div>
						</div>
					</div> <!-- Modal Body -->
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}">
							Cancel
						</button>
						<button type="button" class="btn btn-primary" aria-hidden="true" onclick="javascript: callAdvanceNursery();" th:text="#{common.form.finish.text}">
							Finish
						</button>
					</div>
				</div> <!-- Modal Content -->
			</div>
		</div>
	</form>
</div>
<div layout:fragment="page-script">
	<script type='text/javascript' th:inline="javascript">
	//<![CDATA[

		// FIXME Should not be using global variables or functions
		/*global getJquerySafeId, recreateLocationCombo, recreateModalMethodCombo, showCorrectLocationCombo*/
		/*global showCorrectMethodCombo, checkMethod, lineMethod, plotMethod, validatePlantsSelected*/
		/*global oldMethodSelected, oldLineSelected, lineMethod, plotMethod, validatePlantsSelected*/
		/*global methodSuggestions*/

		// FIXME These variables should be camel case, and should not be global. Dangerous to fix right now,
		// because they are used in so many other files. Don't use ignore! This should be fixed!

		/* jshint ignore:start */
		var locationSuggestions = /*[[${locationList}]]*/ null,
			locationSuggestions_obj = [],

			locationSuggestionsFav = /*[[${favoriteLocationList}]]*/ null,
			locationSuggestionsFav_obj = [],

			methodSuggestions = /*[[${methodList}]]*/ null,
			methodSuggestions_obj = [],

			methodSuggestionsFav = /*[[${favoriteMethodList}]]*/ null,
			methodSuggestionsFav_obj = [],

			msgSamplePlotError = /*[[#{advancing.nursery.number.of.plot.error}]]*/ '',
			msgHarvestDateError = /*[[#{advancing.nursery.harvest.date.error}]]*/ '',
			msgMethodError = /*[[#{advancing.nursery.method.error}]]*/ '',

			oldLineSelected = '',
			oldMethodSelected = '',

			locationIframeOpened = false,
			methodIframeOpened = false,

			linesNotWholeNumberError = /*[[#{error.advancing.nursery.whole.numeric.lines}]]*/ '',
			msgEmptyListError = /*[[#{nursery.advance.nursery.empty.list.error}]]*/ '',
			noMethodVariatesError = /*[[#{error.advancing.nursery.no.method.variates}]]*/ '',
			noLineVariatesError = /*[[#{error.advancing.nursery.no.line.variates}]]*/ '',
			noPlotVariatesError = /*[[#{error.advancing.nursery.no.plot.variates}]]*/ '';
			noMethodValueError = /*[[#{nursery.advance.nursery.empty.method.error}]]*/ '';
			listShouldNotBeEmptyError = /*[[#{nursery.save.advance.error.row.list.empty}]]*/ '';
		/* jshint ignore:end */

		function changeSuffix() {
			'use strict';

			var $input = $('input[type=checkbox][name=methodChoice]'),
				$methodSelectionInput = $('.method-section input'),
				$methodIdAll = $('#methodIdAll'),
				$methodIdFavorite = $('#methodIdFavorite'),
				$methodsSection = $('#methods-section');

			$input.prop('disabled', false);

			checkMethod();
		}

		function showBulkSection(isBulk) {
			'use strict';

			if($('input[type=checkbox][name=methodChoice]:checked').val() !== '1') {
				$('.bulk-section').css('display', 'block');
				$('.lines-section').css('display', 'block');
			}
			else if(isBulk){
				$('.bulk-section').css('display', 'block');
				$('.lines-section').css('display', 'none');
			}else{
				$('.bulk-section').css('display', 'none');
				$('.lines-section').css('display', 'block');
			}
		}

		function changeAdvanceBreedingMethod() {
			'use strict';

			var bMethodId = $('#advanceBreedingMethodId').val(),
				isBulk = false,
				i;

			for (i = 0; i < methodSuggestions.length; i++) {
				if (methodSuggestions[i].mid == bMethodId) {
					if (methodSuggestions[i].bulkingMethod === true) { // Bulk
				 		isBulk = true;
				 	}
					break;
				}
			}
			showBulkSection(isBulk);
		}

		$(function() {
			'use strict';
			recreateLocationCombo();
			recreateModalMethodCombo('advanceBreedingMethodId', 'showAdvanceFavoriteMethod');
			
			$('#s2id_harvestLocationIdFavorite').hide();
			$('#s2id_harvestLocationIdAll').show();

			$('#s2id_methodIdFavorite').hide();
			$('#s2id_methodIdAll').show();


			$('#showFavoriteLocation').on('change', function(){
				showCorrectLocationCombo();
			});

			$('#showFavoriteMethod').on('change', function(){
				showCorrectMethodCombo();
			});

			$('input[type=checkbox][name=methodChoice]').on('change', checkMethod);

			$('input[type=checkbox][name=lineChoice]').on('change', lineMethod);

			$('input[type=checkbox][name=allPlotsChoice]').on('change', plotMethod);

			$('.ps-variate-selection').on('change', function() {
				validatePlantsSelected($(this));
			});

			oldMethodSelected = $('#defaultMethodId').val();
			oldLineSelected = $('#lineSelected').val();

			initializeMethodSelect2(methodSuggestions, methodSuggestions_obj);
			initializeMethodFavSelect2(methodSuggestionsFav, methodSuggestionsFav_obj);
			showCorrectMethodCombo();

			checkMethod();
			lineMethod();
			plotMethod();
			changeSuffix();

			$('#advanceBreedingMethodId').on('change', changeAdvanceBreedingMethod);
			changeAdvanceBreedingMethod();

		});
	//]]>
	</script>
</div>