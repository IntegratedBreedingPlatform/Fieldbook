<div class="col-xs-10 col-md-10" xmlns:th="http://www.thymeleaf.org">
	<form onsubmit="javascript: return validateAdvanceNursery();" id="advanceNurseryModalForm" role="form-horizontal" action="#" th:action="@{/NurseryManager/advance/nursery}" method="post" th:object="${advancingNurseryform}" enctype="multipart/form-data">

		<input type="hidden" th:field="*{breedingMethodUrl}"/>
		<input type="hidden" th:field="*{defaultMethodId}"/>
		<input type="hidden" th:field="*{nurseryId}"/>
		<input type="hidden" th:field="*{harvestDate}"/>
        <input type="hidden" th:field="*{selectedTrialInstances}"/>

		<div class="modal fade" id="advanceNurseryModal" role="dialog" aria-labelledby="advanceNurseryModal" aria-hidden="true">
			<div class="modal-dialog modal-large">
				<div class="modal-content">
					<div class="modal-body">
						<div class="row form-group">
							<div class="col-xs-11 col-md-11">
								<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{nursery.nurserydetails.action.advance}"></label>
							</div>
							<div class="col-xs-1 col-md-1">
								<button  id="closeAdvanceNurseryModal" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
							</div>
						</div>

						<div class="row form-group">
							<div id="page-advance-modal-message"></div>
						</div>

						<div class="row form-group">
							<div class="col-xs-12 col-md-12" >
								<label class=""><em th:utext="#{fieldmap.mandatory.fields}"> Mandatory fields are noted with a *</em></label>
							</div>
						</div>
						<br/>
						<div id="methods-section">

							<div class="row form-group">
								<label class="control-label col-xs-12">
									<strong class="sub-content-heading" th:text="#{advancing.nursery.method}">METHODS</strong>
								</label>
							</div>

							<div class="row form-group">
								<label class="control-label col-xs-6">
									<input type="checkbox" th:field="*{methodChoice}" th:value="*{methodChoice}"/>
									<span class="label-bold" th:text="#{advancing.nursery.breeding.method.the.same}">
										Breeding Method is the same for each advance
									</span>
								</label>

								<div class="row col-xs-6">
									<div class="col-xs-10 method-selection-div">
										<input type="hidden" th:field="*{methodIdAll}" class="select2 non-maize-control" placeholder=""/>
										<input type="hidden" th:field="*{methodIdFavorite}" class="select2 non-maize-control" placeholder=""/>
										<input type="hidden" th:field="*{advanceBreedingMethodId}"/>
									</div>
									<div class="col-xs-2 method-selection-div help-tooltip-col">
										<span data-container="#advanceNurseryModal .modal-body" id="method-tooltip" class="bms-fa-question-circle help-tooltip-nursery help-tooltip-nursery-advance" data-placement="top" data-toggle="tooltip" style="display:inline;"></span>
									</div>
								</div>
							</div>

							<div class="row form-group">

								<div class="col-sm-offset-6 col-xs-6 method-selection-div">
									<label class="non-maize-control">
										<input class="advance-fav-method-checkbox" id="showFavoriteMethod" value="1" type="checkbox"/> <span th:text="#{show.favorite.method}">Show Favorite Method</span>
										&nbsp;&nbsp;&nbsp;
										<a class="advance-manage-method" href="javascript: void(0)" th:text="#{advancing.nursery.manage.method}">Manage Methods</a>
									</label>
								</div>

							</div>

							<div class="row form-group" id="method-variates-section">
								<div class="col-xs-6">
									<label class="control-label label-bold" th:text="#{advancing.nursery.method.variate} + ':'">Choose a variate that defines the breeding method for each advance:</label>
								</div>
								<div class="col-xs-6">
									<select th:field="*{methodVariateId}">
										<option th:each="methodVariate : *{methodVariates}" th:value="${methodVariate.id}" th:text="${methodVariate.name}">
										</option>
									</select>
								</div>
							</div>
						</div>

						<div class="lines-section">
							<div class="row form-group">
								<label class="control-label col-xs-12 add_top_padding" ><strong class="sub-content-heading" th:text="#{advancing.nursery.lines}">LINES</strong> </label>
							</div>
							<div class="row form-group ">
								<label class="control-label col-xs-6">
									<input type="checkbox" th:field="*{lineChoice}" th:value="*{lineChoice}"/>
									<span class="label-bold" th:text="#{advancing.nursery.line.the.same}">Same number of lines is selected for each plot</span>
								</label>
							</div>

							<div class="row form-group lines-per-plot-section">
								<label class="control-label label-bold col-xs-6" th:text="#{advancing.nursery.number.of.samples.plot} + ':'">Lines Selected per Plot:</label>

								<div class="col-xs-3">
									<input class="form-control" type="text" th:field="*{lineSelected}"/>
								</div>

							</div>
							<div class="row form-group" id="line-variates-section">
								<label class="control-label label-bold col-xs-6" th:text="#{advancing.nursery.lines.variate}"></label>
								<div class="col-xs-6">
									<select th:field="*{lineVariateId}" class="ps-variate-selection">
										<option th:each="lineVariate : *{lineVariates}" th:value="${lineVariate.id}" th:text="${lineVariate.name}">
										</option>
									</select>
								</div>
							</div>
						</div>
						<div class="bulk-section">
							<div class="row form-group">
								<label class="control-label col-xs-12 add_top_padding" ><strong class="sub-content-heading" th:text="#{advancing.nursery.bulks}">BULKS</strong> </label>
							</div>
							<div class="row form-group">
								<label class="control-label col-xs-6">
									<input type="checkbox" th:field="*{allPlotsChoice}" th:value="*{allPlotsChoice}" />
									<span class="label-bold" th:text="#{advancing.nursery.all.plots.selected}">All plots are selected</span>
								</label>
							</div>

							<div class="row form-group" id="plot-variates-section">
								<div class="col-xs-6">
									<label class="control-label label-bold" th:text="#{advancing.nursery.bulks.variate}"></label>
								</div>
								<div class="col-xs-6">
									<select th:field="*{plotVariateId}">
										<option th:each="plotVariate : *{plotVariates}" th:value="${plotVariate.id}" th:text="${plotVariate.name}">
										</option>
									</select>
								</div>
							</div>
						</div>

                        <div id="reps-section">
                            <div class="row form-group">
                                <label class="control-label col-xs-12 add_top_padding" ><strong class="sub-content-heading" th:text="#{advancing.nursery.reps}">REPS</strong> </label>
                            </div>
                            <div class="row form-group">

                                <div id="replications" class="col-xs-6" th:each="repIndex: ${replicationsChoices}"  >
                                        <input type="checkbox" class="replication" th:field="*{selectedReplications}" th:value="${repIndex}" />
                                        <span class="label-bold" th:text="${repIndex}"></span>
                                </div>

                                <div class="col-xs-6">
                                    <input type="checkbox" id="selectAllReps" />
                                    <span class="label-bold" th:text="#{advancing.trial.select.all}">Select All</span>
                                </div>
                            </div>
                        </div>

						<div id="harvest-details-section"> <!-- harvest details -->
							<div class="row form-group">
								<label class="control-label col-xs-12 add_top_padding" ><strong class="sub-content-heading" th:text="#{advancing.nursery.harvest.information}">Harvest Details</strong> </label>
							</div>
							<div class="row form-group">
								<label class="control-label label-bold col-xs-6" th:text="#{advancing.nursery.harvest.location}">Harvest Location:</label><span class="required"></span>
								<div class="row col-xs-6">
									<div class="col-xs-10">
										<input type="hidden" th:field="*{harvestLocationIdAll}" class="select2" placeholder=""/>
										<input type="hidden" th:field="*{harvestLocationIdFavorite}" class="select2" placeholder=""/>
										<input type="hidden" th:field="*{harvestLocationId}"/>
										<input type="hidden" th:field="*{harvestLocationName}" />
										<input type="hidden" th:field="*{harvestLocationAbbreviation}" />
									</div>
									<div class="col-xs-2 help-tooltip-col">
										<span data-container="#advanceNurseryModal .modal-body" id="harvestloc-tooltip" class="bms-fa-question-circle help-tooltip-nursery help-tooltip-nursery-advance" data-placement="top" data-toggle="tooltip"></span>
									</div>
								</div>
							</div>

							<div class="row form-group">
								<div class="col-sm-offset-6 col-xs-6">
									<label class="control-label">
										<input class="advance-favorite-location-checkbox" id="showFavoriteLocation" value="1" type="checkbox"/> <span th:text="#{show.favorite.location}">Show Favorite Location</span>
										&nbsp;&nbsp;&nbsp;
										<a class='advance-manage-location' href="javascript: void(0)" th:text="#{advancing.nursery.manage.location}">Manage Locations</a>
									</label>
								</div>
							</div>

							<div class="row form-group">
								<label class="control-label label-bold col-xs-6" th:text="#{advancing.nursery.harvest.date}">Harvest Date</label><span class="required"></span>

								<div class="col-xs-6">
									<div class="pull-left" style="padding-right: 20px">
										<select class="fbk-harvest-year" th:field="*{harvestYear}" style="width: 100px">
											<option th:each="year : ${yearChoices}" th:value="${year.val}" th:text="${year.name}">
											</option>
										</select>
									</div>
									<div class="pull-left">
										<select th:field="*{harvestMonth}" style="width: 100px">
											<option th:each="month : ${monthChoices}" th:value="${month.val}" th:text="${month.name}"></option>
										</select>
									</div>
								</div>

							</div>
							<div class="row form-group add_top_padding">
								<label class="control-label col-xs-12 col-md-12">
									<input type="checkbox" th:field="*{checkAdvanceLinesUnique}" value="1"/>
									<span class="label-bold" th:text="#{advancing.nursery.advance.lines.check.unique.name}">Check the names of advanced lines to ensure they are unique</span>
								</label>
							</div>

						</div>

                        <div id="advance-locations-section">
                            <div class="row form-group">
                                <label class="control-label col-xs-12 add_top_padding" ><strong class="sub-content-heading" th:text="#{advancing.trial.location.information}">Location Details</strong> </label>
                            </div>

                            <div class="row form-group">
                                <div class="row col-xs-8">
                                    <div class="col-xs-10" style="padding-left: 5%">
                                        <div id="location-details-section" class="row form-group">
                                    </div>
                                </div>
                            </div>
                        </div>
                        </div>
					</div> <!-- Modal Body -->
					<div class="modal-footer">
						<button id="nurseryModalCancel" type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}">
							Cancel
						</button>
                        <button id="nurseryModalBack" type="button" class="btn btn-default" onclick="javascript: advanceTrial();" aria-hidden="true" th:text="#{common.form.back.text}">
                            Back
                        </button>
						<button type="button" class="btn btn-primary" aria-hidden="true" onclick="javascript: callAdvanceNursery();" th:text="#{common.form.finish.text}">
							Finish
						</button>
					</div>
				</div> <!-- Modal Content -->
			</div>
		</div>
	</form>
</div>
<div class="row">
	<div th:include="/Common/includes/advanceGermplasmChangeConfirmation"></div>
</div>
<div layout:fragment="page-script">
<script type='text/javascript' th:inline="javascript">
//<![CDATA[

// FIXME Should not be using global variables or functions
/*global getJquerySafeId, recreateLocationCombo, recreateModalMethodCombo, showCorrectLocationCombo*/
/*global showCorrectMethodCombo, checkMethod, lineMethod, plotMethod, validatePlantsSelected*/
/*global oldMethodSelected, oldLineSelected, lineMethod, plotMethod, validatePlantsSelected*/
/*global methodSuggestions, openManageLocations, openManageMethods*/

// FIXME These variables should be camel case, and should not be global. Dangerous to fix right now,
// because they are used in so many other files. Don't use ignore! This should be fixed!

/* jshint ignore:start */
var locationSuggestions = /*[[${locationList}]]*/ null,
	locationSuggestions_obj = [],

	locationSuggestionsFav = /*[[${favoriteLocationList}]]*/ null,
	locationSuggestionsFav_obj = [],

	methodSuggestions = /*[[${methodList}]]*/ null,
	methodSuggestions_obj = [],

	methodSuggestionsFav = /*[[${favoriteMethodList}]]*/ null,
	methodSuggestionsFav_obj = [],

	msgSamplePlotError = /*[[#{advancing.nursery.number.of.plot.error}]]*/ '',
	msgHarvestDateError = /*[[#{advancing.nursery.harvest.date.error}]]*/ '',
	msgMethodError = /*[[#{advancing.nursery.method.error}]]*/ '',

	oldLineSelected = '',
	oldMethodSelected = '',

	locationIframeOpened = false,
	methodIframeOpened = false,

	linesNotWholeNumberError = /*[[#{error.advancing.nursery.whole.numeric.lines}]]*/ '',
	msgEmptyListError = /*[[#{nursery.advance.nursery.empty.list.error}]]*/ '',
	noMethodVariatesError = /*[[#{error.advancing.nursery.no.method.variates}]]*/ '',
	noLineVariatesError = /*[[#{error.advancing.nursery.no.line.variates}]]*/ '',
	noPlotVariatesError = /*[[#{error.advancing.nursery.no.plot.variates}]]*/ '';

noMethodValueError = /*[[#{nursery.advance.nursery.empty.method.error}]]*/ '';
listShouldNotBeEmptyError = /*[[#{nursery.save.advance.error.row.list.empty}]]*/ '';
locationTooltipMessage = /*[[#{advance.nursery.location.tooltip.message} + ' ']]*/ '';
locationTooltipMessage = /*[[#{advance.nursery.location.tooltip.message} + ' ']]*/ '';
noReplicationSelectedError = /*[[#{error.advancing.trial.one.selected.reps}]]*/ '';
/* jshint ignore:end */

function changeSuffix() {
	'use strict';

	var $input = $('input[type=checkbox][name=methodChoice]'),
		$methodSelectionInput = $('.method-section input'),
		$methodIdAll = $('#methodIdAll'),
		$methodIdFavorite = $('#methodIdFavorite'),
		$methodsSection = $('#methods-section');

	$input.prop('disabled', false);

	checkMethod();
}

function showBulkSection(isBulk) {
	'use strict';

	if ($('input[type=checkbox][name=methodChoice]:checked').val() !== '1') {
		$('.bulk-section').css('display', 'block');
		$('.lines-section').css('display', 'block');
	} else if (isBulk) {
		$('.bulk-section').css('display', 'block');
		$('.lines-section').css('display', 'none');
	} else {
		$('.bulk-section').css('display', 'none');
		$('.lines-section').css('display', 'block');
	}
}

function changeAdvanceBreedingMethod() {
	'use strict';

	var bMethodId = $('#advanceBreedingMethodId').val(),
		isBulk = false,
		i;

	for (i = 0; i < methodSuggestions.length; i++) {
		if (methodSuggestions[i].mid == bMethodId) {
			if (methodSuggestions[i].bulkingMethod === true) { // Bulk
				isBulk = true;
			}
			break;
		}
	}
	showBulkSection(isBulk);
}

$(function() {
	'use strict';
	recreateLocationCombo();
	recreateModalMethodCombo('advanceBreedingMethodId', 'showAdvanceFavoriteMethod');

	$('#s2id_harvestLocationIdFavorite').hide();
	$('#s2id_harvestLocationIdAll').show();

	$('#s2id_methodIdFavorite').hide();
	$('#s2id_methodIdAll').show();

	$('#showFavoriteLocation').on('change', function() {
		showCorrectLocationCombo();
	});

	$('#showFavoriteMethod').on('change', function() {
		showCorrectMethodCombo();
	});

	$('input[type=checkbox][name=methodChoice]').on('change', checkMethod);

	$('input[type=checkbox][name=lineChoice]').on('change', lineMethod);

	$('input[type=checkbox][name=allPlotsChoice]').on('change', plotMethod);

	oldMethodSelected = $('#defaultMethodId').val();
	oldLineSelected = $('#lineSelected').val();

	initializeMethodSelect2(methodSuggestions, methodSuggestions_obj);
	initializeMethodFavSelect2(methodSuggestionsFav, methodSuggestionsFav_obj);

	var inputStudyLevelMethodElm = $('input.study-level-method');
	if (inputStudyLevelMethodElm !== null && inputStudyLevelMethodElm.val() !== '' && inputStudyLevelMethodElm.val() !== '0') {
		oldMethodSelected = inputStudyLevelMethodElm.val();
		$('input.advance-fav-method-checkbox').prop('checked', $('input.study-level-method-checkbox').is(':checked'));
	}
	var locationRowIndex = getLocationRowIndex();
	if (locationRowIndex > -1) {
		var studyLevelVariableRowIndexIdValueElm = $('#' + getJquerySafeId('studyLevelVariables' + locationRowIndex + '.value'));
		var studyLevelVariableRowIndexFavoriteElm = $('#' + getJquerySafeId('studyLevelVariables' + locationRowIndex + '.favorite1'));
		if (studyLevelVariableRowIndexIdValueElm.length !== 0 && studyLevelVariableRowIndexIdValueElm.select2('data') !== null) {
			$('input.advance-favorite-location-checkbox').prop('checked', studyLevelVariableRowIndexFavoriteElm.is(':checked'));
			showCorrectLocationCombo();
			var chosenSettingsLocationId = studyLevelVariableRowIndexIdValueElm.select2('data').id,
				indexCounter = 0;
			if (studyLevelVariableRowIndexFavoriteElm.is(':checked')) {
				//meaning favorite is checked
				var harvestLocIdFavElm = $('#harvestLocationIdFavorite');
				harvestLocIdFavElm.select2('data', studyLevelVariableRowIndexIdValueElm.select2('data'));
				for (indexCounter = 0 ; indexCounter < locationSuggestionsFavObj.length; indexCounter++) {
					if (locationSuggestionsFavObj[indexCounter].id == chosenSettingsLocationId) {
						harvestLocIdFavElm.select2('data', locationSuggestionsFavObj[indexCounter]);
						break;
					}
				}
			} else {
				for (indexCounter = 0 ; indexCounter < locationSuggestionsObj.length; indexCounter++) {
					if (locationSuggestionsObj[indexCounter].id == chosenSettingsLocationId) {
						$('#harvestLocationIdAll').select2('data', locationSuggestionsObj[indexCounter]);
						break;
					}
				}
			}
		}
	}

	showCorrectMethodCombo();

	checkMethod();
	lineMethod();
	plotMethod();
	changeSuffix();

	$('#advanceBreedingMethodId').on('change', changeAdvanceBreedingMethod);
	changeAdvanceBreedingMethod();

	var advNurseryModalElm = $('#advanceNurseryModal');

	// remove any other listeners for the location update
	$(document).off('location-update');
	$(document).on('location-update', recreateLocationCombo);
	$('.advance-manage-method').on('click', function() {
		advNurseryModalElm.modal('hide');
		advNurseryModalElm.data('open', '1');
		setTimeout(openManageMethods, 500);
	});
	$('.advance-manage-location').on('click', function() {
		advNurseryModalElm.modal('hide');
		advNurseryModalElm.data('open', '1');
		setTimeout(openManageLocations, 500);
	});
	advNurseryModalElm.data('open', '0');

    if(!isNursery()){
        $("#nurseryModalCancel").hide();
        $("#reps-section").show();

        $("#advance-locations-section").show();
        $("#harvest-details-section").hide();
    }
    else{
        $("#reps-section").hide();
        $("#nurseryModalBack").hide();

        $("#advance-locations-section").hide();
        $("#harvest-details-section").show();
    }

    // Select All Replication checkbox when click on select All
    $("#selectAllReps").change(function(){
        $(".replication").prop('checked', $(this).prop("checked"));
    });

});
//]]>
</script>
</div>
