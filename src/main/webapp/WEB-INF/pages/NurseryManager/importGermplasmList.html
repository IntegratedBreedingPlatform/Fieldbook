<div class="row form-group collapse in germplasmListDetails">
	<!-- Germplasm List Table View -->
	<div class="col-xs-12 col-md-12">

		<div id="primary-section" style="float: left; width: 70%">
			<img th:src="@{/static/img/review-list-details.png}" style="padding-bottom:3px;" />
			<label class="control-label"><strong id="germplasmLabel" class="sub-content-heading">Nursery List</strong></label>
			<br />
			<label class="control-label"><a href="javascript: openListTree(1)">Browse</a> for a list to work with.</label>
		</div>
		<div id="checks-section" style="float: left; width: 30%; padding-top: 8px">
			<img th:src="@{/static/img/build-new-list.png}" style="padding-bottom:3px;" />
			<label class="control-label"><strong class="sub-content-heading">Selected Checks&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</strong></label>
			<br/>
			<label class="control-label"><a href="javascript: openListTree(2)">Browse</a> for a list to work with.</label>
			<div style="float: right">
				<a style="margin-top: -10px; padding: 6px 8px;" href="javascript: showManageCheckTypePopup()" th:text="#{germplasm.list.manage.check.types}" class="btn btn-info">Manage Checks</a>
			</div>
		</div>
	</div>
	<div class="col-xs-12 col-md-12" id="entries-details" style="display: none">
		<div style="float: left; width: 70%">
			Total Entries: <label class="control-label control-label-bold" id="numberOfEntries"></label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript: void(0)" onclick="javascript: viewGermplasmLitDetails();">View Header</a>
		</div>
		<div style="float: left; width: 30%;"></div>
	</div>
</div>
<div class="row form-group collapse in germplasmListDetails">
	<!-- Germplasm List Table View -->
	<div class="col-xs-12 col-md-12">
		<div id="imported-germplasm-list" class="list-droppable primary add-border" style="float: left; width: 68%"></div>
		<div id="check-germplasm-list" class="list-droppable check add-border" style="float: left; width: 30%;margin-left: 20px;"></div>
	</div>
	<div class="col-xs-12 col-md-12">
		<div id="imported-germplasm-list-reset-button" style="float: left; width: 70%; opacity: 0">
			<a style="margin-top: 10px; padding: 6px 8px;" href="javascript: resetGermplasmList()" class="btn btn-default">Clear</a>
		</div>
		<div id="check-germplasm-list-reset-button" style="opacity: 0; float: left; width: 30%;padding-left: 10px; ">
			<a style="margin-top: 10px; padding: 6px 8px;" href="javascript: resetCheckList()" class="btn btn-default">Clear</a>
		</div>
	</div>
</div>

<div class="row form-group collapse in germplasmListDetails">
	<!-- Germplasm List Table View -->
	<div class="col-xs-12 col-md-12">
		<div id="specifyCheckSection" style="display: none" th:include="/NurseryManager/includes/importGermplasmListCheckSection"/>
	</div>
</div>

<input type="hidden" id="keyForOverwrite" value=""/>
<input type="hidden" id="lastCheckSourcePrimary" value=""/>

<!-- Modal for overwriting checks list -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-body">
				<div>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<br />
				</div>
				<div class="col-xs-12 col-lg-12" th:text="#{import.germplasm.overwrite.current.checks}">
					Are you sure you want to overwrite existing checks with a new one?
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}">Cancel</button>
				<button type="button" th:value="#{common.form.ok.text}" data-dismiss="modal" class="btn btn-primary" th:text="#{common.form.ok.text}" onclick="javascript: overwriteChecksList();">Ok</button>
			</div>
		</div>
	</div>
</div>

<!-- Modal for removing check if it is set as starting entry -->
<div class="modal fade" id="removeCheckModal" tabindex="-1" role="dialog" aria-labelledby="removeCheckModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-body">
				<div>
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<br />
				</div>
				<div class="col-xs-12 col-lg-12" th:text="#{import.germplasm.remove.check}">
					The specified starting entry is already assigned as a check, do you want to continue and remove it from the checks list?
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}" >Cancel</button>
				<button type="button" th:value="#{common.form.ok.text}" data-dismiss="modal" class="btn btn-primary" th:text="#{common.form.ok.text}" onclick="javascript: removeCheckFromList();">Ok</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="listTreeModal" tabindex="-1" role="dialog" aria-labelledby="listTreeModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-extra-small">
		<div class="modal-content">
			<div class="modal-header">
				<button id="closelistTreeModal" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title" id="heading-modal" th:text="#{import.browse.for.list}">
					Browse for List
				</h4>
			</div>
			<div class="modal-body">
				<div class="row">
					<div id="page-import-message-modal" class="col-xs-12 col-md-12">
					</div>
				</div>

				<div class="row">
					<div class="col-xs-6 col-md-6">
						<img th:src="@{/static/img/build-new-list.png}" style="padding-bottom:3px;" />
						<label class="control-label"><strong class="sub-content-heading" th:text="#{browse.for.list.all.list}">All List</strong></label>
					</div>
					<div class="col-xs-6 col-md-6">
						<div style="float: right; padding-right: 15px">
							<img onclick="javascript: addGermplasmFolder(this)" th:src="@{/static/img/add 2.png}" class="image-padding browse-germplasm-action" />
							<img onclick="javascript: renameGermplasmFolder(this)" th:src="@{/static/img/edit.png}" class="image-padding browse-germplasm-action edit-germplasm-folder" />
							<img onclick="javascript: deleteGermplasmFolder(this)" th:src="@{/static/img/delete.png}" class="image-padding browse-germplasm-action delete-germplasm-folder" />
							<button id="closeStudyTreeModal" type="button" class="close" data-dismiss="modal" aria-hidden="true">&nbsp;&nbsp;&nbsp;X</button>
						</div>
					</div>
				</div>
				<div class="row col-xs-12 col-md-12" >
					<!-- Germplasm List Tree View -->
					<div id="germplasmTree" style="height:350px; overflow:auto;"></div>
				</div>
				<br />
				<a class="btn btn-info" href="javascript: openImportGermplasmList()" th:text="#{nursery.import.germplasm.list}">Import File</a>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}">Cancel</button>
				<button type="button" class="btn btn-primary" th:text="#{common.form.select.text}" onclick="javascript: chooseList();">Ok</button>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div id="manage-location" th:include="/NurseryManager/includes/importGermplasmListModal"></div>
</div>
<div class="row">
	<div id="manage-location" th:include="/NurseryManager/includes/importGermplasmListManageCheckType"></div>
</div>

<div class="row">
	<div id="open-germplasm" th:include="/NurseryManager/includes/importGermplasmListDetailsModal"></div>
</div>

<!-- Scripts location, note that the div tag will be remove after merging to decorator -->
<div layout:fragment="page-script">
	<script type="text/javascript" th:src="@{/static/js/lib/jquery/jquery-multisortable.js}"></script>
	<script type="text/javascript" th:src="@{/static/js/lib/jquery/jquery.tablednd.0.7.min.js}"></script>
	<script type='text/javascript' th:inline="javascript">
		var isIE = false;
	</script>
	<!--[if IE]>
	<script type="text/javascript">
		isIE = true;
		//any other IE specific stuff here
	</script>
	<![endif]-->
	<script type="text/javascript" th:inline="javascript">
		//<![CDATA[
		/* jshint ignore:start */
		var addedGid = {},
			listId = 0,
			makeDraggableBool = true,

			startIndex = 0,
			lastDraggedPrimaryList = 0,
			lastDraggedChecksList = 0,
			lastStartingEntry = 0,

			germplasmStartingEntry = /*[[#{import.germplasm.germplasm.specified.starting.entry}]]*/ '',
			germplasmAddedAsCheck = /*[[#{import.germplasm.germplasm.added.as.check}]]*/ '',
			startingEntryErr = /*[[#{import.germplasm.starting.entry.in.check.list}]]*/ '',
			sameListErr = /*[[#{import.germplasm.same.list.primary.check}]]*/ '',
			startingEntryRequired = /*[[#{import.germplasm.starting.entry.required}]]*/ '',

			itemsToAdd = [],
			checksFromPrimary = 0,

			importLocationUrl = /*[[#{nursery.apps.import.nursery.url}]]*/ '',
			importIframeOpened = false,
			itemsIndexAdded = [];
		/* jshint ignore:end */

		var makeCheckDraggableBool = true,
			hasPageError = /*[[${importGermplasmListForm.hasError}]]*/ '';

		// FIXME Should be camel case, but it's used in too many files to easily change. Also, what is this
		// function actually doing?
		function do_validation() {
			'use strict';
			var message = /*[[#{common.error.file.no.file.selected}]]*/ '';
			return true;
		}

		// FIXME What is this function doing?
		function changeCheckLayout() {
			'use strict';
			var radioVal = $('input[name=\'specifyCheckType\']:checked').val();
		}

		// FIXME There is a lot of repeated code in the next two functions
		function makeCheckDraggable(isDraggable) {
			'use strict';

			makeCheckDraggableBool = isDraggable;

			if (isDraggable) {
				$('.check-germplasm-list-items tr').draggable({

					helper: function(/*event, ui*/) {

						var width = $(this)[0].offsetWidth,
							selected = $('.check-germplasm-list-items tr.checkGermplasmSelectedRow'),
							container;

						if (selected.length === 0) {
							selected = $(this).addClass('checkGermplasmSelectedRow');
						}

						container = $('<table style="width:' + width + 'px; background-color:green;"/>').attr('id', 'draggingContainer');
						container.append(selected.clone().removeClass('checkGermplasmSelectedRow'));
						return container;
					},

					revert: 'invalid',

					start: function (/*event, ui*/) {
						var selected = $('.check-germplasm-list-items tr.checkGermplasmSelectedRow');
						$(selected).css('opacity', '.5');
					},

					stop: function (/*event, ui*/) {
						var selected = $('.check-germplasm-list-items tr.checkGermplasmSelectedRow');
						$(selected).css('opacity', '1');
					}
				});

				$('.check-germplasm-list-items tbody tr').off('click').on('click', function (){
					$(this).toggleClass('checkGermplasmSelectedRow');
				});

			} else {
				if ($('.check-germplasm-list-items .ui-draggable').length !== 0) {
					$('.check-germplasm-list-items tr').draggable( 'destroy' );
				}
				$('.check-germplasm-list-items tbody tr').off('click');
			}

			// Change the background of selected rows
			$('.check-germplasm-list-items tr.checkGermplasmSelectedRow').removeClass('checkGermplasmSelectedRow');
		}

		function makeDraggable(isDraggable) {
			'use strict';

			if (isDraggable) {
				$('.germplasm-list-items tr').draggable({

					helper: function(/*event, ui*/) {
						var width = $(this)[0].offsetWidth,
							selected = $('.germplasm-list-items tr.germplasmSelectedRow'),
							container;

						if (selected.length === 0) {
							selected = $(this).addClass('germplasmSelectedRow');
						}

						container = $('<table style="width:' + width + 'px; background-color:green;" />').attr('id', 'draggingContainer');
						container.append(selected.clone().removeClass('germplasmSelectedRow'));

						return container;
					},

					revert: 'invalid',

					start: function (/*event, ui*/) {
						var selected = $('.germplasm-list-items tr.germplasmSelectedRow');
						$(selected).css('opacity', '.5');
					},

					stop: function (/*event, ui*/) {
						var selected = $('.germplasm-list-items tr.germplasmSelectedRow');
						$(selected).css('opacity', '1');
					}
				});

				$('.germplasm-list-items tbody tr').off('click').on('click', function (){
					$(this).toggleClass('germplasmSelectedRow');
				});

			} else {
				if ($('.germplasm-list-items .ui-draggable').length !== 0) {
					$('.germplasm-list-items tr').draggable('destroy');
				}
				$('.germplasm-list-items tbody tr').off('click');
			}

			// Change background of selected rows
			$('.germplasm-list-items tr.germplasmSelectedRow').removeClass('germplasmSelectedRow');
		}		

		function addCheckGermplasmList(entryNumber, gid, index) {
			'use strict';

			// FIXME Not sure if the following condition is relying on implicit type conversion. See other instances of this in this file

			// If the germplasm record has been specified as starting index
			if (addedGid[gid] == null) {
				addedGid[gid] = gid;
			} else {
				var itemsAddedCounter = 0;
				for(itemsAddedCounter = 0 ; itemsAddedCounter < itemsIndexAdded.length ; itemsAddedCounter++){
					if(parseInt(itemsIndexAdded[itemsAddedCounter].index, 10) == index) {
						showErrorMessage('page-message', germplasmAddedAsCheck);
						moveToTopScreen();
						return false;
					}
				}
				
				
			}

			$('#check-germplasm-list').removeClass('add-border');

			Spinner.toggle();
			var selectedCheckVal = '';
			for (var checkIndex = 0; checkIndex < $('.checkRow').length; checkIndex++) {
				var checkId = $('select.checklist-select:eq(' + checkIndex + ')').val() ;
				if(checkId === '')
					checkId = '0'
				selectedCheckVal += checkId + ':'; 							
			}

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/addCheckGermplasmDetails/' + entryNumber,
				type: 'GET',
				data: 'selectedCheckVal='+selectedCheckVal,
				cache: false,
				async: false,

				success: function(html) {

					$('#check-germplasm-list').html(html);
					makeCheckDraggable(true);
					showSpecifyCheckSection();
					checksFromPrimary++;
					setSpinnerMaxValue();
					itemsIndexAdded.push({'entry':entryNumber, 'gid': gid, 'index': index});

					if (index == $('#startIndex2').val() && $('.check-germplasm-list-items .ui-draggable').length !== 0){
						index++;
							prevStartIndex = $('#startIndex2').val();
						}

					},

					error: function(jqXHR, textStatus, errorThrown){
						console.log('The following error occured: ' + textStatus, errorThrown);
					},

					complete: function() {
						Spinner.toggle();
					}
				});
			return true;
		}

		function showSpecifyCheckSection() {
			'use strict';

			if ($('.check-germplasm-list-items tr').length === 0) {
				$('#specifyCheckSection').css('display', 'none');
				$('#check-germplasm-list-reset-button').css('opacity', '0');
			} else {
				$('#check-germplasm-list-reset-button').css('opacity', '1');
				$('#specifyCheckSection').css('display', 'block');
			}
		}

		function hideAddCol(isHide) {
			'use strict';

			makeDraggable(!isHide);
			makeDraggableBool = !isHide;
		}

		function displayGermplasmCheckDetails(listId) {
			'use strict';

			hideAddCol(false);
			Spinner.toggle();
			$('#'+getDisplayedTreeName()).find('*').removeClass('dynatree-selected');

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/displayCheckGermplasmDetails/' + listId,
				type: 'GET',
				cache: false,

				success: function(html) {
					$('#check-germplasm-list').html(html);
					showSpecifyCheckSection();
					checksFromPrimary = 0;
					setSpinnerMaxValue();
					itemsIndexAdded = [];

				},

				error: function(jqXHR, textStatus, errorThrown){
					console.log('The following error occured: ' + textStatus, errorThrown);
				},

				complete: function() {
					Spinner.toggle();
				}
			});
		}

		function resetCheckList() {
			'use strict';
			hideAddCol(false);
			Spinner.toggle();
			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/resetCheckGermplasmDetails',
				type: 'GET',
				cache: false,
				async: false,

				success: function(html) {
					$('#check-germplasm-list').html('<h3></h3>');
					$('#check-germplasm-list').addClass('add-border');
					addedGid = {};
					showSpecifyCheckSection();
					makeCheckDraggable(true);
					// Set primary germplasm list rows' opacity to 1
					$('.germplasm-list-items tbody tr').css('opacity', '1');
					lastDraggedChecksList = 0;
					lastStartingEntry = 0;
				},

				error: function(jqXHR, textStatus, errorThrown){
					console.log('The following error occured: ' + textStatus, errorThrown);
				},

				complete: function() {
					Spinner.toggle();
				}
			});
		}

		function overwriteChecksList() {
			'use strict';

			var i;

			if ($('#keyForOverwrite').val() !== '') {
				displayGermplasmCheckDetails($('#keyForOverwrite').val());
			} else {
				resetCheckList();
				for (i = 0; i < itemsToAdd.length ; i++) {
					if (addCheckGermplasmList(itemsToAdd[i].entry, itemsToAdd[i].gid, itemsToAdd[i].index)){
						$('.primaryRow[data-entry="' + itemsToAdd[i].entry+ '"]').css('opacity', '0.5');
					}
				}
				$('.germplasm-list-items tr.germplasmSelectedRow').removeClass('germplasmSelectedRow');
			}
			// FIXME How do we even know what this is here?
			$(this).removeClass('add-border');
		}

		function deleteCheckGermplasmList(entryNumber, gid) {
			'use strict';

			Spinner.toggle();

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/deleteCheckGermplasmDetails/' + gid,
				type: 'GET',
				cache: false,
				async: false,

				success: function(data) {

					var indexItems,
						rowGid;

					addedGid[gid] = null;
					checksFromPrimary--;
					setSpinnerMaxValue();

					if (itemsIndexAdded != null && itemsIndexAdded.length > 0) {

						for (indexItems = 0 ; indexItems < itemsIndexAdded.length ; indexItems++) {
							if(itemsIndexAdded[indexItems] != null) {
								rowGid = itemsIndexAdded[indexItems].gid;

								// FIXME Not sure if this is relying on implicit type conversion
								if (rowGid == gid) {
									itemsIndexAdded[indexItems] = null;
									break;
								}
	
							}
						}
					}
				},

				error: function(jqXHR, textStatus, errorThrown){
					console.log('The following error occured: ' + textStatus, errorThrown);
				},

				complete: function() {
					Spinner.toggle();
				}
			});
		}

		function isFunction(functionToCheck) {
			'use strict';
			var getType = {};
			return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
		}

		function displayGermplasmDetails(listIdTemp) {
			'use strict';

			listId = listIdTemp;
			Spinner.toggle();
			$('#'+getDisplayedTreeName()).find('*').removeClass('dynatree-selected');

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/displayGermplasmDetails/' + listId,
				type: 'GET',
				cache: false,

				success: function(html) {
					$('#imported-germplasm-list').html(html);
					changeCheckLayout();
					makeDraggable(makeDraggableBool);
					checksFromPrimary = 0;
					setSpinnerMaxValue();

					$('#entries-details').css('display', 'block');

					$('#numberOfEntries').html($('#totalGermplasms').val());
					$('#imported-germplasm-list-reset-button').css('opacity', '1');
					itemsIndexAdded = [];

					if (lastDraggedChecksList == 0) {
						// We clear the list in the check
						resetCheckList();
					}
				},

				error: function(jqXHR, textStatus, errorThrown){
					console.log('The following error occured: ' + textStatus, errorThrown);
				},

				complete: function() {
					Spinner.toggle();
				}
			});
		}

		function resetGermplasmList() {
			'use strict';

			$('#imported-germplasm-list').html('<h3></h3>');
			$('#imported-germplasm-list').addClass('add-border');
			$('#imported-germplasm-list-reset-button').css('opacity', '0');
			$('#entries-details').css('display', 'none');
			listId = 0;
			lastDraggedPrimaryList = 0;

			Spinner.toggle();
			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/resetNurseryGermplasmDetails',
				type: 'GET',
				cache: false,
				async: false,
				success: function(html) {
					Spinner.toggle();
				}
			});
		}

		function getGid(index) {
			'use strict';
			return $($('.germplasm-list-items tbody tr').get(index-1)).data('gid');
		}

		function verifyIfCheck(startingIndex) {
			'use strict';

			if (false && ($('tr.checkRow[data-index="' + $(startingIndex).val() + '"]').length !== 0 ||
				isGidInCheckList(getGid($(startingIndex).val())) > 0)) {

				if (lastDraggedChecksList == 0 && $('#keyForOverwrite').val() === '') {
					// Only pop if its a drag item from primary
					$('#removeCheckModal').modal({ backdrop: 'static', keyboard: true });
				}
			} else {
				lastStartingEntry = $(startingIndex).val();
			}
		}

		function isGidInCheckList(gid) {
			'use strict';

			var entryNo = 0;
			$.each($('.check-germplasm-list-items tbody tr'), function(index, row) {
				if ($(row).data('gid') == gid) {
					entryNo = parseInt($(row).data('entry'), 10);
				}
			});
			return entryNo;
		}

		function removeCheckFromList() {
			'use strict';

			var gid = $('tr.checkRow[data-index="' + $('#startIndex2').val()+ '"]').data('gid'),
				entryNo = isGidInCheckList(gid);

			deleteCheckGermplasmList(entryNo, gid);
			$.each($('.germplasm-list-items tbody tr'), function (index, row) {
				if ($(row).data('entry') == entryNo && $(row).data('gid') == gid) {
					$(row).removeAttr('style');
				}
			});

			lastStartingEntry = $('#startIndex2').val();

			$('.check-germplasm-list-items tr[data-entry=' + entryNo + ']').remove();
			if ($('.check-germplasm-list-items tbody tr').length === 0) {
				resetCheckList();
			}
		}
	
		function openListTree(type) {
			'use strict';
			openTreeType = type;
			$('#listTreeModal').modal('show');
			$('#page-import-message-modal').html('');
			additionalLazyLoadUrl = '/0';
		}

		function chooseList() {
			'use strict';

			var node = $('#'+getDisplayedTreeName()).dynatree('getTree').getActiveNode();

			if (node.data.isFolder) {
				showErrorMessage('page-import-message-modal', pleaseChooseFolder);
			} else {
				if (openTreeType == 1) {
					// Load in main list
					if (lastDraggedChecksList != node.data.key) {
						// Loads the primary germplasm list
						$('#'+getJquerySafeId('imported-germplasm-list')).removeClass('add-border');
						lastDraggedPrimaryList = node.data.key;
						displayGermplasmDetails(node.data.key);
					} else {
						showErrorMessage('page-import-message-modal', sameListErr);
						return;
					}
				} else if(openTreeType == 2) {
					// Load in check list
					if (lastDraggedPrimaryList != node.data.key) {
						// Loads the check list
						$('#lastCheckSourcePrimary').val(0);
						lastDraggedChecksList = node.data.key;

						// Set primary germplasm list rows' opacity to 1
						$('.germplasm-list-items tbody tr').css('opacity', '1');

						// If there is an existing list already, ask user if data should be overwritten
						if ($('.check-germplasm-list-items tbody tr').length > 0) {
							$('#keyForOverwrite').val(node.data.key);
							$('#confirmationModal').modal('show');
						} else {
							displayGermplasmCheckDetails(node.data.key);
							$('#'+getJquerySafeId('check-germplasm-list')).removeClass('add-border');
						}
						makeCheckDraggable(false);
					} else {
						showErrorMessage('page-import-message-modal', sameListErr);
						return;
					}
				}
				$('#listTreeModal').modal('hide');
			}
		}

		function viewGermplasmLitDetails() {
			'use strict';
			openGermplasmListDetailsPopop(listId);
		}

		function activateDroppable() {
			'use strict';

			$('.list-droppable').droppable({
				hoverClass: 'drophover',
				addClasses: true,
				over: function(event, ui) {
				},

				drop: function(event, ui) {

					if ($('#listTreeModal').hasClass('in') == true) {
						return false;
					}

					var source = ui.helper.data('dtSourceNode') || ui.draggable;

					if (!isFunction(source.data)) {
						if ($(this).hasClass('primary')) {
							if (lastDraggedChecksList != source.data.key) {
								// Loads the primary germplasm list
								$(this).removeClass('add-border');
								lastDraggedPrimaryList = source.data.key;
								displayGermplasmDetails(source.data.key);
							} else {
								showErrorMessage('page-message', sameListErr);
								moveToTopScreen();
							}
						} else if($(this).hasClass('check')) {
							if (lastDraggedPrimaryList != source.data.key) {
								// Loads the check list
								$('#lastCheckSourcePrimary').val(0);
								lastDraggedChecksList = source.data.key;

								// Set primary germplasm list rows' opacity to 1
								$('.germplasm-list-items tbody tr').css('opacity', '1');

								// If there is an existing list already, ask user if data should be overwritten
								if ($('.check-germplasm-list-items tbody tr').length > 0) {
									$('#keyForOverwrite').val(source.data.key);
									$('#confirmationModal').modal('show');
								} else {
									displayGermplasmCheckDetails(source.data.key)
									$(this).removeClass('add-border');
								}
								makeCheckDraggable(false);
							} else {
								showErrorMessage('page-message', sameListErr);
								moveToTopScreen();
							}
						}
					} else if (isFunction(source.data) && $(this).hasClass('check') &&
						$(ui.helper.find('tr').get(0)).hasClass('primaryRow')) {

					 	// If not all items are dragged to the checks list
					 	if (ui.helper.find('tr').length !== $('.germplasm-list-items tbody tr').length - ui.helper.find('tr').length) {

							// Adds the dragged germplasms to the check list
							if (lastDraggedChecksList != 0) {
								itemsToAdd = [];
								$('#keyForOverwrite').val('');
								$.each(ui.helper.find('tr'), function (index, row) {
									var entryNumber = $(row).data('entry');
									var gid = ''+$(row).data('gid');
									var index = $(row).data('index');
									itemsToAdd.push({'entry':entryNumber, 'gid': gid, 'index': index});
								});

								$('#confirmationModal').modal('show');
							} else {
								$.each(ui.helper.find('tr'), function (index, row) {
									var entryNumber = $(row).data('entry'),
										gid = '' + $(row).data('gid'),
										idx = '' + $(row).data('index');
									if(addCheckGermplasmList(entryNumber, gid, idx)){
										$('.germplasm-list-items tr.germplasmSelectedRow').removeClass('germplasmSelectedRow');
									}
								});
							}
							$('#lastCheckSourcePrimary').val(1);
						} else {
							showErrorMessage('page-message', sameListErr);
							moveToTopScreen();
						}
					} else if (isFunction(source.data) && $(this).hasClass('primary') &&
						$(ui.helper.find('tr').get(0)).hasClass('checkRow')) {

					// Removes the items from the check list
					var checkListCount = $('.check-germplasm-list-items tbody tr').length;

						$.each(ui.helper.find('tr'), function (index, row) {
							var entryNumber = $(row).data('entry'),
								gid = '' + $(row).data('gid');

							deleteCheckGermplasmList(entryNumber, gid);
							$.each($('.germplasm-list-items tbody tr'), function (index, row) {
								if ($(row).data('entry') == entryNumber && $(row).data('gid') == gid) {
									$(row).removeAttr('style');
								}
							});
							//subtract original and cloned row
							checkListCount = checkListCount-2;
						});
						$('.check-germplasm-list-items tr.checkGermplasmSelectedRow').remove();
						if (checkListCount == 0) {
							resetCheckList();
						}
					}
				}
			});
		}

		$(document).ready(function() {
			'use strict';

			// FIXME This is relying on implicit type conversion - also see other uses of == in this file
			if (hasPageError == 1){
				// Show the modal dialog again
				$('#myModal').modal('show');
			}

			// Display tree
			$('input[name="specifyCheckType"]').on('change', changeCheckLayout);

			changeCheckLayout();
			showSpecifyCheckSection();

			// FIXME Should not be user agent checking, or changing CSS in JavaScript
			if(isIE){
				$('#primary-section').css('width', '67%');
				$('#checks-section').css('width', '33%');
			}
			$('#entries-details').css('display', 'none');

			displayGermplasmListTree('germplasmTree', false);
			activateDroppable();
			changeBrowseGermplasmButtonBehavior(false);

			$('#listTreeModal').on('hide.bs.modal', function() {
				$('#'+getDisplayedTreeName()).dynatree('getTree').reloadStudyTree();
				changeBrowseGermplasmButtonBehavior(false);
			});
		});
	//]]>
	</script>
</div>
