<div class="row form-group collapse in germplasmListDetails germplasmAndCheckSection">
	<!-- Germplasm List Table View -->
	<div>

        <div id="primary-section" class="col-xs-8 col-md-8">
            <div><img th:src="@{/static/img/review-list-details.png}" />
                <label class="control-label"><strong id="germplasmLabel" class="sub-content-heading">Nursery List</strong></label>
            </div>
            <div>
                <label class="control-label"><a href="javascript: openListTree(1)">Browse</a> or <a href="javascript: openImportGermplasmList('1')">Import</a> a list to work with.</label>
            </div>
        </div>
        <div id="checks-section" style="padding-top: 8px" class="col-xs-4 col-md-4 nopadding">
            <div class="col-xs-10 nopadding">
                <div>
                    <div style="display:inline-block; width: 30px; padding: 4px 0 5px 0"><img th:src="@{/static/img/build-new-list.png}" /></div>
                    <label class="control-label"><strong class="sub-content-heading">Selected Checks</strong></label>
                </div>
                <div>
                    <label class="control-label"><a href="javascript: openListTree(2)">Browse</a> or <a href="javascript: openImportGermplasmList('2')">Import</a> a list to work with.</label>
                </div>

            </div>
            <div class="col-xs-2 nopadding">
                <a class="pull-right btn btn-info" href="javascript: showManageCheckTypePopup()" th:text="#{germplasm.list.manage.check.types}" >Manage Checks</a>
            </div>
        </div>
    </div>
    <div  id="entries-details" style="display: none">
        <div class="col-xs-8 col-md-8">
            Total Entries: <label class="control-label control-label-bold" id="numberOfEntries"></label>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="javascript: void(0)"
                                                                                                                                                     onclick="javascript: viewGermplasmLitDetails();">View Header</a>
        </div>
        <div class="col-xs-4 col-md-4"></div>
    </div>
</div>
<div class="row form-group collapse in germplasmListDetails">
    <!-- Germplasm List Table View -->
    <div >
        <div class="col-xs-8 col-md-8">
            <div id="imported-germplasm-list" class="list-droppable primary"></div>
        </div>

        <div class="col-xs-4 col-md-4 nopadding">
            <div id="check-germplasm-list" class="list-droppable check"></div>
        </div>

    </div>
</div>

<div class="row form-group collapse in germplasmListDetails">
	<!-- Germplasm List Table View -->
	<div class="col-xs-12 col-md-12">
		<div id="specifyCheckSection" style="display: none" th:include="/NurseryManager/includes/importGermplasmListCheckSection"/>
	</div>
</div>

<input type="hidden" id="keyForOverwrite" value=""/>
<input type="hidden" id="lastCheckSourcePrimary" value=""/>

<!-- Modal for overwriting checks list -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-extra-small">
		<div class="modal-content">
			<div class="modal-body">
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">					
						<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{common.form.confirmation.text}"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						<button  id="close" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
					</div>										
				</div>
				
				<div class="row form-group">
					<div class="col-xs-12 col-md-12" th:text="#{import.germplasm.overwrite.current.checks}">
						Are you sure you want to overwrite existing checks with a new one?
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}">Cancel</button>
				<button type="button" th:value="#{common.form.ok.text}" data-dismiss="modal" class="btn btn-primary" th:text="#{common.form.ok.text}" onclick="javascript: overwriteChecksList();">Ok</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="confirmReplaceListModal" tabindex="-1" role="dialog" aria-labelledby="confirmReplaceListModal" aria-hidden="true">
	<div class="modal-dialog modal-extra-small">
		<div class="modal-content">			
			<div class="modal-body">		
			
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">					
						<label class="modal-title fbk-modal-title" id="heading-modal" th:text="#{common.form.confirmation.text}"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						<button  id="close" type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
					</div>										
				</div>
				<div class="row form-group">
					<div class="col-xs-12 col-lg-12" th:text="#{germplasm.list.confirm.replace.with.check}">
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<input type="hidden" id="replaceListId"/>
				<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.no.text}" >Cancel</button>
				<button type="button" th:value="#{common.form.ok.text}" data-dismiss="modal" class="btn btn-primary" th:text="#{common.form.yes.text}" onclick="javascript: confirmReplaceList();">Ok</button>
			</div>
		</div>
	</div>
</div>
<!-- Modal for removing check if it is set as starting entry -->
<div class="modal fade" id="removeCheckModal" tabindex="-1" role="dialog" aria-labelledby="removeCheckModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-extra-small">
		<div class="modal-content">
			<div class="modal-body">
				<div class="row form-group">
					<div class="col-xs-11 col-md-11">					
						<label class="modal-title fbk-modal-title" id="heading-modal"></label>
					</div>
					<div class="col-xs-1 col-md-1">
						<button  type="button" class="close  pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true"/>
					</div>										
				</div>				
				<div class="row form-group">
					<div class="col-xs-12 col-lg-12" th:text="#{import.germplasm.remove.check}">
						The specified starting entry is already assigned as a check, do you want to continue and remove it from the checks list?
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}" >Cancel</button>
				<button type="button" th:value="#{common.form.ok.text}" data-dismiss="modal" class="btn btn-primary" th:text="#{common.form.ok.text}" onclick="javascript: removeCheckFromList();">Ok</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="listTreeModal" tabindex="-1" role="dialog" aria-labelledby="listTreeModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-extra-small">
		<div class="modal-content">
			
			<div class="modal-body">							
				
				<div class="row">
					<div id="page-import-message-modal" class="col-xs-12 col-md-12">
					</div>
				</div>

				<div class="row form-group modal-popover ">
					<div class="col-xs-6 col-md-6">
						<img th:src="@{/static/img/build-new-list.png}" class="fbk-icon-header" />
						<label class="control-label fbk-modal-title" th:text="#{browse.for.list.all.list}">All List</label>
					</div>
					<div class="col-xs-5 col-md-5">
						<div class="pull-right">
							<img onclick="javascript: addGermplasmFolder(this)" th:src="@{/static/img/add 2.png}" class="image-padding browse-germplasm-action" />
							<img onclick="javascript: renameGermplasmFolder(this)" th:src="@{/static/img/edit.png}" class="image-padding browse-germplasm-action edit-germplasm-folder" />
							<img onclick="javascript: deleteGermplasmFolder(this)" th:src="@{/static/img/delete.png}" class="image-padding browse-germplasm-action delete-germplasm-folder" />
						</div>
					</div>
					<div class="col-xs-1 col-md-1 ">
						<button id="closeStudyTreeModal" type="button" class="close pull-right glyphicon glyphicon-remove" data-dismiss="modal" aria-hidden="true" style="padding-top: 5px"></button>
					</div>
				</div>
				<div class="row form-group" >
					<!-- Germplasm List Tree View -->
					<div class="col-md-12 col-xs-12 germplasm-tree-section" id="germplasmTree" style="height:350px; overflow:auto;"></div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal" aria-hidden="true" th:text="#{common.form.cancel.text}">Cancel</button>
				<button type="button" class="btn btn-primary" th:text="#{common.form.select.text}" onclick="javascript: chooseList();">Ok</button>
			</div>
		</div>
	</div>
</div>

<div class="row">
	<div id="manage-location" th:include="/NurseryManager/includes/importGermplasmListModal"></div>
</div>
<div class="row">
	<div id="manage-location" th:include="/NurseryManager/includes/importGermplasmListManageCheckType"></div>
</div>

<div class="row">
	<div id="open-germplasm" th:include="/NurseryManager/includes/importGermplasmListDetailsModal"></div>
</div>

<!-- Scripts location, note that the div tag will be remove after merging to decorator -->
<div layout:fragment="page-script">
	<script type="text/javascript" th:src="@{/static/js/lib/jquery/jquery-multisortable.js}"></script>
	<script type="text/javascript" th:src="@{/static/js/lib/jquery/jquery.tablednd.0.7.min.js}"></script>
	
	<script type="text/javascript" th:inline="javascript">
		//<![CDATA[
		/*globals Spinner, moveToTopScreen, getDisplayedTreeName, showSpecifyCheckSection, setSpinnerMaxValue*/
		/*globals prevStartIndex, showErrorMessage,germplasmAddedAsCheck, openTreeType, sameListErr*/
		/*globals changeBrowseGermplasmButtonBehavior, getJquerySafeId, displayGermplasmListTree, pleaseChooseFolder*/
		/*globals openGermplasmListDetailsPopop*/
		/*exported startIndex,germplasmStartingEntry,importLocationUrl,importIframeOpened,overwriteChecksList*/
		/*exported confirmReplaceList,resetGermplasmList,removeCheckFromList,openListTree,viewGermplasmLitDetails */
		/*exported additionalLazyLoadUrl, chooseList*/
		var addedGid = {},
			listId = 0,
			makeDraggableBool = true,

			startIndex = 0,
			lastDraggedPrimaryList = 0,
			lastDraggedChecksList = 0,

			itemsToAdd = [],
			checksFromPrimary = 0,

			importLocationUrl = /*[[#{nursery.apps.import.nursery.url}]]*/ '',
			importIframeOpened = false,
			itemsIndexAdded = [];
		

		var makeCheckDraggableBool = true,
			hasPageError = /*[[${importGermplasmListForm.hasError}]]*/ '';
		

		// FIXME There is a lot of repeated code in the next two functions
		function makeCheckDraggable(isDraggable) {
			'use strict';

			makeCheckDraggableBool = isDraggable;

			if (isDraggable) {
				$('.check-germplasm-list-items tbody tr').draggable({

					helper: function(/*event, ui*/) {

						var width = $(this)[0].offsetWidth,
							selected = $('.check-germplasm-list-items tr.checkGermplasmSelectedRow'),
							container;

						if (selected.length === 0) {
							selected = $(this).addClass('checkGermplasmSelectedRow');
						}

						container = $('<table style="width:' + width + 'px; background-color:green;"/>').attr('id', 'draggingContainer');
						container.append(selected.clone().removeClass('checkGermplasmSelectedRow'));
						return container;
					},

					revert: 'invalid',

					start: function (/*event, ui*/) {
						var selected = $('.check-germplasm-list-items tr.checkGermplasmSelectedRow');
						/*$(selected).css('opacity', '.5');*/
					},

					stop: function (/*event, ui*/) {
						var selected = $('.check-germplasm-list-items tr.checkGermplasmSelectedRow');
						$(selected).css('opacity', '1');
					},

                    zIndex : 9999,

                    appendTo : '#chooseGermplasmAndChecks'
				});

				$('.check-germplasm-list-items tbody tr').off('click').on('click', function (){
					$(this).toggleClass('checkGermplasmSelectedRow');
				});

			} else {
				if ($('.check-germplasm-list-items .ui-draggable').length !== 0) {
					$('.check-germplasm-list-items tbody  tr').draggable( 'destroy' );
				}
				$('.check-germplasm-list-items tbody tr').off('click');
			}

			// Change the background of selected rows
			$('.check-germplasm-list-items tr.checkGermplasmSelectedRow').removeClass('checkGermplasmSelectedRow');
		}

		function makeDraggable(isDraggable) {
			'use strict';

			if (isDraggable) {
				$('.germplasm-list-items tbody  tr').draggable({

					helper: function(/*event, ui*/) {
						var width = $(this)[0].offsetWidth,
							selected = $('.germplasm-list-items tr.germplasmSelectedRow'),
							container;

						if (selected.length === 0) {
							selected = $(this).addClass('germplasmSelectedRow');
						}

						container = $('<table style="width:' + width + 'px; background-color:green;" />').attr('id', 'draggingContainer');
						container.append(selected.clone().removeClass('germplasmSelectedRow'));

						return container;
					},

					revert: 'invalid',

					start: function (/*event, ui*/) {
						var selected = $('.germplasm-list-items tr.germplasmSelectedRow');
						/*$(selected).css('opacity', '.5');*/
					},

					stop: function (/*event, ui*/) {
						var selected = $('.germplasm-list-items tr.germplasmSelectedRow');
						$(selected).css('opacity', '1');
					},

                    zIndex : 9999,

                    appendTo : '#chooseGermplasmAndChecks'
				});

				$('.germplasm-list-items tbody tr').off('click').on('click', function (){
					$(this).toggleClass('germplasmSelectedRow');
				});

			} else {
				if ($('.germplasm-list-items .ui-draggable').length !== 0) {
					$('.germplasm-list-items tbody  tr').draggable('destroy');
				}
				$('.germplasm-list-items tbody tr').off('click');
			}

			// Change background of selected rows
			$('.germplasm-list-items tr.germplasmSelectedRow').removeClass('germplasmSelectedRow');
		}		

		function addCheckGermplasmList(entryNumber, gid, index) {
			'use strict';

			// FIXME Not sure if the following condition is relying on implicit type conversion. See other instances of this in this file

			// If the germplasm record has been specified as starting index
			if (addedGid[gid] == null) {
				addedGid[gid] = gid;
			} else {
				var itemsAddedCounter = 0;
				for(itemsAddedCounter = 0 ; itemsAddedCounter < itemsIndexAdded.length ; itemsAddedCounter++){
					if(itemsIndexAdded[itemsAddedCounter] !== null && parseInt(itemsIndexAdded[itemsAddedCounter].index, 10) === index) {
						showErrorMessage('page-message', germplasmAddedAsCheck);
						moveToTopScreen();
						return false;
					}
				}
				
				
			}

			var selectedCheckVal = '';
			for (var checkIndex = 0; checkIndex < $('.checkRow').length; checkIndex++) {
				var checkId = $('select.checklist-select:eq(' + checkIndex + ')').val() ;
				if(checkId === '') {
					checkId = '0';
				}
				selectedCheckVal += checkId + ':'; 							
			}

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/addCheckGermplasmDetails/' + entryNumber,
				type: 'GET',
				data: 'selectedCheckVal='+selectedCheckVal,
				cache: false,
				async: false,

				success: function(html) {

					$('#check-germplasm-list').html(html);
					makeCheckDraggable(true);
					showSpecifyCheckSection();
					checksFromPrimary++;
					setSpinnerMaxValue();
					itemsIndexAdded.push({'entry':entryNumber, 'gid': gid, 'index': index});

						if (index == $('#startIndex2').val() && $('.check-germplasm-list-items .ui-draggable').length !== 0){
							index++;
							prevStartIndex = $('#startIndex2').val();
						}
				}
			});
			return true;
		}

		function showSpecifyCheckSection() {
			'use strict';

			if ($('.check-germplasm-list-items tr').length === 0) {
				$('#specifyCheckSection').css('display', 'none');
				$('#check-germplasm-list-reset-button').css('opacity', '0');
			} else {
				$('#check-germplasm-list-reset-button').css('opacity', '1');
				$('#specifyCheckSection').css('display', 'block');
			}
		}

		function hideAddCol(isHide) {
			'use strict';

			makeDraggable(!isHide);
			makeDraggableBool = !isHide;
		}

		function displayGermplasmCheckDetails(listId) {
			'use strict';

			hideAddCol(false);
			$('#'+getDisplayedTreeName()).find('*').removeClass('dynatree-selected');

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/displayCheckGermplasmDetails/' + listId,
				type: 'GET',
				cache: false,

				success: function(html) {
					$('#check-germplasm-list').html(html);
					showSpecifyCheckSection();
					checksFromPrimary = 0;
					setSpinnerMaxValue();
					itemsIndexAdded = [];
				}
			});
		}

		function resetCheckList() {
			'use strict';
			hideAddCol(false);
			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/resetCheckGermplasmDetails',
				type: 'GET',
				cache: false,
				async: false,

				success: function() {
					$('#check-germplasm-list').html('<h3></h3>');
					addedGid = {};
					showSpecifyCheckSection();
					makeCheckDraggable(true);
					// Set primary germplasm list rows' opacity to 1
					$('.germplasm-list-items tbody tr').css('opacity', '1');
					lastDraggedChecksList = 0;
				}
			});
		}

		function overwriteChecksList() {
			'use strict';

			var i;

			if ($('#keyForOverwrite').val() !== '') {
				displayGermplasmCheckDetails($('#keyForOverwrite').val());
			} else {
				resetCheckList();
				for (i = 0; i < itemsToAdd.length ; i++) {
					addCheckGermplasmList(itemsToAdd[i].entry, itemsToAdd[i].gid, itemsToAdd[i].index)					
				}
				$('.germplasm-list-items tr.germplasmSelectedRow').removeClass('germplasmSelectedRow');
			}			
		}

		function deleteCheckGermplasmList(entryNumber, gid) {
			'use strict';


			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/deleteCheckGermplasmDetails/' + gid,
				type: 'GET',
				cache: false,
				async: false,

				success: function() {

					var indexItems,
						rowGid;

					addedGid[gid] = null;
					checksFromPrimary--;
					setSpinnerMaxValue();

					if (itemsIndexAdded != null && itemsIndexAdded.length > 0) {

						for (indexItems = 0 ; indexItems < itemsIndexAdded.length ; indexItems++) {
							if(itemsIndexAdded[indexItems] != null) {
								rowGid = itemsIndexAdded[indexItems].gid;

								// FIXME Not sure if this is relying on implicit type conversion
								if (rowGid == gid) {
									itemsIndexAdded[indexItems] = null;
									break;
								}
	
							}
						}
					}
				}
			});
		}

		function isFunction(functionToCheck) {
			'use strict';
			var getType = {};
			return functionToCheck && getType.toString.call(functionToCheck) === '[object Function]';
		}
		
		function displayListDetails(listIdTemp) {
			'use strict';

			listId = listIdTemp;
			$('#'+getDisplayedTreeName()).find('*').removeClass('dynatree-selected');

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/displayGermplasmDetails/' + listId,
				type: 'GET',
				cache: false,

				success: function(html) {
					$('#imported-germplasm-list').html(html);
					makeDraggable(makeDraggableBool);
					checksFromPrimary = 0;
					setSpinnerMaxValue();

					$('#entries-details').css('display', 'block');

					$('#numberOfEntries').html($('#totalGermplasms').val());
					$('#imported-germplasm-list-reset-button').css('opacity', '1');
					itemsIndexAdded = [];

					if (lastDraggedChecksList == 0) {
						// We clear the list in the check
						resetCheckList();
					}
				}
			});
		}
		function displayGermplasmDetails(listIdTemp){
			'use strict';
			if (lastDraggedChecksList === 0 && $('.check-germplasm-list-items tbody tr').length > 0){
				$('#confirmReplaceListModal #replaceListId').val(listIdTemp);
				$('#confirmReplaceListModal').modal({ backdrop: 'static', keyboard: true });	
			}else {
				displayListDetails(listIdTemp);
			}
			
		}
		function confirmReplaceList(){
			'use strict';
			
			displayListDetails($('#confirmReplaceListModal #replaceListId').val());
		}

		function resetGermplasmList() {
			'use strict';

			$('#imported-germplasm-list').html('<h3></h3>');
			$('#imported-germplasm-list-reset-button').css('opacity', '0');
			$('#entries-details').css('display', 'none');
			listId = 0;
			lastDraggedPrimaryList = 0;

			$.ajax({
				url: '/Fieldbook/NurseryManager/importGermplasmList/resetNurseryGermplasmDetails',
				type: 'GET',
				cache: false,
				async: false,
				success: function() {
				}
			});
		}

		function isGidInCheckList(gid) {
			'use strict';

			var entryNo = 0;
			$.each($('.check-germplasm-list-items tbody tr'), function(index, row) {
				if ($(row).data('gid') == gid) {
					entryNo = parseInt($(row).data('entry'), 10);
				}
			});
			return entryNo;
		}

		function removeCheckFromList() {
			'use strict';

			var gid = $('tr.checkRow[data-index="' + $('#startIndex2').val()+ '"]').data('gid'),
				entryNo = isGidInCheckList(gid);

			deleteCheckGermplasmList(entryNo, gid);
			$.each($('.germplasm-list-items tbody tr'), function (index, row) {
				if ($(row).data('entry') == entryNo && $(row).data('gid') == gid) {
					$(row).removeAttr('style');
				}
			});


			$('.check-germplasm-list-items tr[data-entry=' + entryNo + ']').remove();
			if ($('.check-germplasm-list-items tbody tr').length === 0) {				
				resetCheckList();
			}
		}
	
		function openListTree(type) {
			'use strict';
			openTreeType = type;
			$('#listTreeModal').modal({ backdrop: 'static', keyboard: true });
			$('#page-import-message-modal').html('');
			additionalLazyLoadUrl = '/0';
			$('.popover').hide();
		}

		function chooseList(){
			'use strict';
			var node = $('#'+getDisplayedTreeName()).dynatree('getTree').getActiveNode();
			chooseListNode(node, false);
		}

		function chooseListNode(node, fromEnterKey) {
			'use strict';		

			if (node === null || node.data.isFolder) {
				if(fromEnterKey === false){
					showErrorMessage('page-import-message-modal', pleaseChooseFolder);
				}
			} else {
				if (openTreeType === 1) {
					// Load in main list
					if (lastDraggedChecksList != node.data.key) {
						// Loads the primary germplasm list
						lastDraggedPrimaryList = node.data.key;
						displayGermplasmDetails(node.data.key);
					} else {
						if(fromEnterKey === false){
							showErrorMessage('page-import-message-modal', sameListErr);
							return;	
						}
						
					}
				} else if(openTreeType === 2) {
					// Load in check list
					if (lastDraggedPrimaryList != node.data.key) {
						// Loads the check list
						$('#lastCheckSourcePrimary').val(0);
						lastDraggedChecksList = node.data.key;

						// Set primary germplasm list rows' opacity to 1
						$('.germplasm-list-items tbody tr').css('opacity', '1');

						// If there is an existing list already, ask user if data should be overwritten
						if ($('.check-germplasm-list-items tbody tr').length > 0) {
							$('#keyForOverwrite').val(node.data.key);
							$('#confirmationModal').modal('show');
						} else {
							displayGermplasmCheckDetails(node.data.key);
						}
						makeCheckDraggable(false);
					} else {
						if(fromEnterKey === false){
							showErrorMessage('page-import-message-modal', sameListErr);
							return;
						}
					}
				}
				$('#listTreeModal').modal('hide');
			}
		}

		function viewGermplasmLitDetails() {
			'use strict';
			openGermplasmListDetailsPopop(listId);
		}

		function activateDroppable() {
			'use strict';

			$('.list-droppable').droppable({				
                tolerance: 'pointer',
				addClasses: true,
				over: function(/*event, ui*/) {
				},

				drop: function(event, ui) {

					if ($('#listTreeModal').hasClass('in') === true) {
						return false;
					}

					var source = ui.helper.data('dtSourceNode') || ui.draggable;

					if (!isFunction(source.data)) {
						if ($(this).hasClass('primary')) {
							if (lastDraggedChecksList != source.data.key) {
								// Loads the primary germplasm list
								lastDraggedPrimaryList = source.data.key;
								displayGermplasmDetails(source.data.key);
							} else {
								showErrorMessage('page-message', sameListErr);
								moveToTopScreen();
							}
						} else if($(this).hasClass('check')) {
							if (lastDraggedPrimaryList != source.data.key) {
								// Loads the check list
								$('#lastCheckSourcePrimary').val(0);
								lastDraggedChecksList = source.data.key;

								// Set primary germplasm list rows' opacity to 1
								$('.germplasm-list-items tbody tr').css('opacity', '1');

								// If there is an existing list already, ask user if data should be overwritten
								if ($('.check-germplasm-list-items tbody tr').length > 0) {
									$('#keyForOverwrite').val(source.data.key);
									$('#confirmationModal').modal('show');
								} else {
									displayGermplasmCheckDetails(source.data.key);
								}
								makeCheckDraggable(false);
							} else {
								showErrorMessage('page-message', sameListErr);
								moveToTopScreen();
							}
						}
					} else if (isFunction(source.data) && $(this).hasClass('check') &&
						$(ui.helper.find('tr').get(0)).hasClass('primaryRow')) {

					 	// If not all items are dragged to the checks list
					 	if (ui.helper.find('tr').length !== $('.germplasm-list-items tbody tr').length - ui.helper.find('tr').length) {

							// Adds the dragged germplasms to the check list
							if (lastDraggedChecksList != 0) {
								itemsToAdd = [];
								$('#keyForOverwrite').val('');
								$.each(ui.helper.find('tr'), function (index, row) {
									var entryNumber = $(row).data('entry');
									var gid = ''+$(row).data('gid');
									var index = $(row).data('index');
									itemsToAdd.push({'entry':entryNumber, 'gid': gid, 'index': index});
								});

								$('#confirmationModal').modal('show');
							} else {
								$.each(ui.helper.find('tr'), function (index, row) {
									var entryNumber = $(row).data('entry'),
										gid = '' + $(row).data('gid'),
										idx = '' + $(row).data('index');
									if(addCheckGermplasmList(entryNumber, gid, idx)){
										$('.germplasm-list-items tr.germplasmSelectedRow').removeClass('germplasmSelectedRow');
									}
								});
							}
							$('#lastCheckSourcePrimary').val(1);
						} else {
							showErrorMessage('page-message', sameListErr);
							moveToTopScreen();
						}
					} else if (isFunction(source.data) && $(this).hasClass('primary') &&
						$(ui.helper.find('tr').get(0)).hasClass('checkRow')) {

					// Removes the items from the check list

						$.each(ui.helper.find('tr'), function (index, row) {
							var entryNumber = $(row).data('entry'),
								gid = '' + $(row).data('gid');

							deleteCheckGermplasmList(entryNumber, gid);
							$.each($('.germplasm-list-items tbody tr'), function (index, row) {
								if ($(row).data('entry') == entryNumber && $(row).data('gid') == gid) {
									$(row).removeAttr('style');
								}
							});
						});
						$('.check-germplasm-list-items tr.checkGermplasmSelectedRow').remove();
						if ($('.check-germplasm-list-items tbody tr').length === 0) {		
							resetCheckList();
						}
					}
				}
			});
		}

		$(document).ready(function() {
			'use strict';

			// FIXME This is relying on implicit type conversion - also see other uses of == in this file
			if (hasPageError === 1){
				// Show the modal dialog again
				$('#myModal').modal('show');
			}

			// Display tree			
			showSpecifyCheckSection();

			
			$('#entries-details').css('display', 'none');

			displayGermplasmListTree('germplasmTree', false, 0);
			activateDroppable();
			changeBrowseGermplasmButtonBehavior(false);

			$('#listTreeModal').on('hide.bs.modal', function() {
				$('#'+getDisplayedTreeName()).dynatree('getTree').reloadStudyTree();
				changeBrowseGermplasmButtonBehavior(false);
			});
		});
	//]]>
	</script>
</div>
