<div class="col-md-7" xmlns:th="http://www.thymeleaf.org">
	<br/>
	<input type="button" th:value="#{ontology.browser.button.add.new.variable}" class="btn btn-default btn-log" data-toggle="modal" href="#addVariableModal" onClick="clearFields()" />
	<!-- Modal -->
  	<form id="addVariableForm" role="form-horizontal" onsubmit="return do_validation()"  class="form-horizontal" action="#" 
	    th:action="@{/OntologyBrowser/}" method="post" enctype="multipart/form-data" th:object="${ontologyBrowserForm}">
	   	<div class="modal fade" id="addVariableModal" role="dialog" aria-labelledby="addVariableLabel" aria-hidden="true">
			<div class="modal-dialog modal-large" style="width:900px">
		    	<div class="modal-content">
		        	<div class="modal-header">
		           		<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		           		<h4 class="modal-title" th:text="#{ontology.browser.header.add.new.variable}">Add a New Variable</h4>
		         	</div>
		         	<div class="modal-body" id="addVariableBody">
		         		<div class="form-group" id="page-message-modal"></div>
            			<div id="errorHandler" th:class="${#fields.hasErrors('*')} ? 'form-group has-error' : 'form-group'">
            				<div class="alert alert-danger" th:if="${#fields.hasErrors('*')} " th:each="err : ${#fields.errors('*')}" th:text="${err}"></div>
			         		<div class="row fluid">
				         		<div class="col-md-5">
									<div class="form-group">
					           			<label for="variableName" class="col-md-5 control-label" th:text="#{ontology.browser.modal.variable.name} + ': *'">Name:</label>
				                        <div class="col-md-7">
				                            <input type="text" th:field="*{variableName}" class="form-control"/>
				                        </div>
			                        </div>
			                        
			                        <div class="form-group">
					           			<label for="variableDescription" class="col-md-5 control-label" th:text="#{ontology.browser.modal.description} + ':'">Description:</label>
					           			<div class="col-md-7">
				                            <textarea th:field="*{variableDescription}" class="form-control" size="10"> </textarea>
				                        </div>
									</div>
									
									<br/>
									
									<div class="form-group">
										<label for="dataType" class="col-md-5 control-label" th:text="#{ontology.browser.modal.data.type} + ': *'">Data Type:</label>
										<div class="col-md-7">
											<select class="form-control" th:field="*{dataType}">
				                        		<option value="">Select</option>
				                        		<option th:each="type : ${dataTypes}" th:value="${type.id}" th:text="${type.name}"/>
				                        	</select>
										</div>
									</div>
									
									<div class="form-group">
										<label for="role" class="col-md-5 control-label" th:text="#{ontology.browser.modal.role} + ': *'">Role:</label>
										<div class="col-md-7">
											<select class="form-control" th:field="*{role}">
				                        		<option value="">Select</option>
				                        		<option th:each="role : ${roles}" th:value="${role.id}" th:text="${role.name}"/>
				                        	</select>
										</div>
									</div>
									
									<div class="form-group">
					           			<label for="cropOntologyId" class="col-md-5 control-label" th:text="#{ontology.browser.modal.crop.ontology.id} + ':'">Crop Ontology ID:</label>
				                        <div class="col-md-7">
				                            <input type="text" th:field="*{cropOntologyId}" class="form-control"/>
				                        </div>
			                        </div>
								</div>
				         		<div class="col-md-6">
				         			<div class="form-group">                        
				                        <label for="comboTraitClass" class="col-md-5 control-label" th:text="#{ontology.browser.modal.trait.class} + ': *'">Class:</label>
				                        <div class="col-md-7">
				                        	<div class="input-group">
				                        		<input id="comboTraitClass" type="hidden" th:field="*{traitClass}" class="form-control select2" placeholder=""/>
				                        		<span class="input-group-btn">
					                        		<button class="btn btn-primary" type="button" id="btnAddTraitClass" onClick="doSave('TraitClass')">
					                        			<span class="glyphicon glyphicon-plus"></span>
					                        		</button>
			                        			</span>
				                        	</div>
				                        </div>
			                        </div>
			                        
			                        <div class="form-group">
					                	<label for="traitClassDescription" class="col-md-5 control-label" th:text="#{ontology.browser.modal.description} + ':'">Description:</label>
					                    <div class="col-md-7">
					                    	<textarea type="text" th:field="*{traitClassDescription}" class="form-control" size="10"> </textarea>
					                    </div>
				                    </div>
				                    
				                    <div class="form-group">                        
				                        <label for="comboProperty" class="col-md-5 control-label" th:text="#{ontology.browser.modal.property} + ': *'">Property:</label>
				                        <div class="col-md-7">
				                        	<div class="input-group">
					                        	<input id="comboProperty" type="hidden" th:field="*{property}" class="form-control select2" placeholder=""/>
					                        	<span class="input-group-btn">
					                        		<button class="btn btn-primary" type="button" id="btnAddProperty" onClick="doSave('Property')">
					                        			<span class="glyphicon glyphicon-plus"></span>
					                        		</button>
			                        			</span>
		                        			</div>
				                        </div>
			                        </div>
			                        
			                        <div class="form-group">
					                	<label for="propertyDescription" class="col-md-5 control-label" th:text="#{ontology.browser.modal.description} + ':'">Description:</label>
					                    <div class="col-md-7">
					                    	<textarea type="text" th:field="*{propertyDescription}" class="form-control" size="10"> </textarea>
					                    </div>
				                    </div>
				                    
				                    <div class="form-group">                        
				                        <label for="comboMethod" class="col-md-5 control-label" th:text="#{ontology.browser.modal.method} + ': *'">Method:</label>
				                        <div class="col-md-7">
				                        	<div class="input-group">
					                        	<input id="comboMethod" type="hidden" th:field="*{method}" class="form-control select2" placeholder=""  />
					                        	<span class="input-group-btn">
					                        		<button class="btn btn-primary" type="button" id="btnAddMethod" onClick="doSave('Method')">
					                        			<span class="glyphicon glyphicon-plus"></span>
					                        		</button>
			                        			</span>
		                        			</div>
				                        </div>
			                        </div>
			                        
			                        <div class="form-group">
					                	<label for="methodDescription" class="col-md-5 control-label" th:text="#{ontology.browser.modal.description} + ':'">Description:</label>
					                    <div class="col-md-7">
					                    	<textarea type="text" th:field="*{methodDescription}" class="form-control" size="10"> </textarea>
					                    </div>
				                    </div>
				                    
				                    <div class="form-group">                        
				                        <label for="comboScale" class="col-md-5 control-label" th:text="#{ontology.browser.modal.scale} + ': *'">Scale:</label>
				                        <div class="col-md-7">
				                        	<div class="input-group">
					                        	<input id="comboScale" type="hidden" th:field="*{scale}" class="form-control select2" placeholder=""/>
				                        		<span class="input-group-btn">
					                        		<button class="btn btn-primary" type="button" id="btnAddScale" onClick="doSave('Scale')">
					                        			<span class="glyphicon glyphicon-plus"></span>
					                        		</button>
			                        			</span>
		                        			</div>
				                        </div>
			                        </div>
			                        
			                        <div class="form-group">
					                	<label for="scaleDescription" class="col-md-5 control-label" th:text="#{ontology.browser.modal.description} + ':'">Description:</label>
					                    <div class="col-md-7">
					                    	<textarea type="text" th:field="*{scaleDescription}" class="form-control" size="10"> </textarea>
					                    </div>
				                    </div>
				         		</div>
				         		<div class="col-md-1"></div>
			           		</div>
		           		</div>
		         	</div>																							
		       		<div class="modal-footer">
		         		<button type="button" th:value="#{common.form.cancel.text}" class="btn btn-primary"
		         		 th:text="#{common.form.cancel.text}" data-dismiss="modal" aria-hidden="true">Cancel</button>
		         		<button type="submit" th:value="#{common.form.add.text}" class="btn btn-primary" 
		         		th:text="#{common.form.add.text}">Add</button>      	
	       			</div>
		     	</div><!-- /.modal-content -->
	   		</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
	</form>		
</div>

<div layout:fragment="page-script">		
	<script type='text/javascript' th:inline="javascript">
	//<![CDATA[
        var traitClassesSuggestions = /*[[${traitClassesSuggestionList}]]*/ null;
		var propertySuggestions = /*[[${propertiesSuggestionList}]]*/ null;
		var methodSuggestions = /*[[${methodsSuggestionList}]]*/ null;
		var scaleSuggestions = /*[[${scalesSuggestionList}]]*/ null;
		
	  	var traitClassesSuggestions_obj = [];
	  	var propertySuggestions_obj = [];
	  	var methodSuggestions_obj = [];
	  	var scaleSuggestions_obj = [];
	  	
	  	var traitClassesDescription = [];
	  	var propertyDescription = [];
	  	var methodDescription = [];
	  	var scaleDescription = [];
			  	
		$(function () {
			
			
		  	$.each(traitClassesSuggestions, function( index, value ) {
		  		traitClassesSuggestions_obj.push({ 'id' : value.id,
  				  'text' : value.name,
  				  'description' : value.description
				});  
		  		
			});
		  	
		  	$.each(propertySuggestions, function( index, value ) {
		  		propertySuggestions_obj.push({ 'id' : value.id,
  				  'text' : value.name,
  				  'description' : value.definition
				});  
			});
		  	
		  	$.each(methodSuggestions, function( index, value ) {
		  		methodSuggestions_obj.push({ 'id' : value.id,
  				  'text' : value.name,
  				  'description' : value.definition
				});  
			});
		  	
		  	$.each(scaleSuggestions, function( index, value ) {
		  		scaleSuggestions_obj.push({ 'id' : value.id,
  				  'text' : value.name,
  				  'description' : value.definition
				});  
			});
		  	
		  	$("#comboTraitClass").select2({
	            query: function (query) {
	              var data = {results: traitClassesSuggestions_obj}, i, j, s;
	              // return the array that matches
	              data.results = $.grep(data.results,function(item,index) {
	                return ($.fn.select2.defaults.matcher(query.term,item.text));
	              
	              });
	              if (data.results.length === 0) data.results.unshift({id:query.term,text:query.term});
	              
	                query.callback(data);
	            }
	  
	        }).on("change", function(){
	        	$("#traitClassDescription").val($("#comboTraitClass").select2("data").description);
	        });
		  	
		  	$("#comboProperty").select2({
	            query: function (query) {
	              var data = {results: propertySuggestions_obj}, i, j, s;
	              // return the array that matches
	              data.results = $.grep(data.results,function(item,index) {
	                return ($.fn.select2.defaults.matcher(query.term,item.text));
	              
	              });
	              if (data.results.length === 0) data.results.unshift({id:query.term,text:query.term});
	              
	                query.callback(data);
	            }
	  
	        }).on("change", function(){
	        	$("#propertyDescription").val($("#comboProperty").select2("data").description);
	        });
		  	
		  	$("#comboMethod").select2({
	            query: function (query) {
	              var data = {results: methodSuggestions_obj}, i, j, s;
	              // return the array that matches
	              data.results = $.grep(data.results,function(item,index) {
	                return ($.fn.select2.defaults.matcher(query.term,item.text));
	              
	              });
	              if (data.results.length === 0) data.results.unshift({id:query.term,text:query.term});
	              
	                query.callback(data);
	            }
	  
	        }).on("change", function(){
	        	$("#methodDescription").val($("#comboMethod").select2("data").description);
	        });
		  	
		  	$("#comboScale").select2({
	            query: function (query) {
	              var data = {results: scaleSuggestions_obj}, i, j, s;
	              // return the array that matches
	              data.results = $.grep(data.results,function(item,index) {
	                return ($.fn.select2.defaults.matcher(query.term,item.text));
	              
	              });
	              if (data.results.length === 0) data.results.unshift({id:query.term,text:query.term});
	              
	                query.callback(data);
	            }
	  
	        }).on("change", function(){
	        	$("#scaleDescription").val($("#comboScale").select2("data").description);
	        });
		  	
		  //$("#comboTraitClass").data("ui-combobox").value($("#hidTraitClass").val());
		  //$("#comboProperty").data("ui-combobox").value($("#hidProperty").val());
		  //$("#comboMethod").data("ui-combobox").value($("#hidMethod").val());
		  //$("#comboScale").data("ui-combobox").value($("#hidScale").val());
		});

		function onBeforeSubmit() {
	        //$("#hidTraitClass").val($("#comboTraitClass").data("ui-combobox").value());
	        //$("#hidProperty").val($("#comboProperty").data("ui-combobox").value());
	        //$("#hidMethod").val($("#comboMethod").data("ui-combobox").value());
	        //$("#hidScale").val($("#comboScale").data("ui-combobox").value());
	    }
		
		function doSave(combo) {
			if (validateCombo(combo)) {
				var $form = $("#addVariableForm");
				serializedData = $form.serialize();
				Spinner.toggle();
				
				$.ajax({
					url: "addVariable/" + combo,
					type: "post",
					dataType: "json",
					data: serializedData,
				    success: function(data){
					    if (data.status == "1") {
					    	recreateCombo(combo, data);					    	
				       	} else {
				       		//to do
				       		//$("#error-message").html(data.errorMessage);
				       		//$("#page-message").show();
				       	}
				   }, 
				   error: function(jqXHR, textStatus, errorThrown){
						console.log("The following error occured: " + textStatus, errorThrown);
				   }, 
				   complete: function(){ 
					   Spinner.toggle();
				   } 
				});
				
				$("#page-message-modal").html("");
			}
		}
		
		function validateCombo(combo) {
			var message = null;
			
			if ($("#combo"+combo).val() == "") {
				if (combo == "TraitClass") {
					message = /*[[#{ontology.browser.modal.combo.no.value(#{ontology.browser.modal.trait.class})}]]*/;
				} else if (combo == "Property") {
					message = /*[[#{ontology.browser.modal.combo.no.value(#{ontology.browser.modal.property})}]]*/;
				} else if (combo == "Method") {
					message = /*[[#{ontology.browser.modal.combo.no.value(#{ontology.browser.modal.method})}]]*/;
				} else {
					message = /*[[#{ontology.browser.modal.combo.no.value(#{ontology.browser.modal.scale})}]]*/;	
				}
		    	$("#page-message-modal").html(
					    "<div class='alert alert-danger'>"+ message +"</div>"
				);
				  
				return false;
			}
			
			if ($("#combo"+combo).select2("data").id != $("#combo"+combo).select2("data").text && $("#combo"+combo).select2("data").description != undefined) {
				
				if (combo == "TraitClass") {
					message = /*[[#{ontology.browser.modal.item.exists(#{ontology.browser.modal.trait.class})}]]*/;
				} else if (combo == "Property") {
					message = /*[[#{ontology.browser.modal.item.exists(#{ontology.browser.modal.property})}]]*/;
				} else if (combo == "Method") {
					message = /*[[#{ontology.browser.modal.item.exists(#{ontology.browser.modal.method})}]]*/;
				} else {
					message = /*[[#{ontology.browser.modal.item.exists(#{ontology.browser.modal.scale})}]]*/;	
				}
		    	$("#page-message-modal").html(
					    "<div class='alert alert-danger'>"+ message +"</div>"
				);
				  
				return false;
			}
			return true;
		}
		
		function recreateCombo(combo, data) {
			var suggestions_obj = [];
			var description = null;
			
			//add the new data in the collection
			if (combo == "TraitClass") {
				traitClassesSuggestions_obj.push({ 'id' : data.id,
					  'text' : data.name,
					  'description' : data.definition
				});
				suggestions_obj = traitClassesSuggestions_obj;
				description = $("#traitClassDescription");
			} else if (combo == "Property") {
				propertySuggestions_obj.push({ 'id' : data.id,
					  'text' : data.name,
					  'description' : data.definition
				});
				suggestions_obj = propertySuggestions_obj;
			} else if (combo == "Method") {
				methodSuggestions_obj.push({ 'id' : data.id,
					  'text' : data.name,
					  'description' : data.definition
				});
				suggestions_obj = methodSuggestions_obj;
			} else {
				scaleSuggestions_obj.push({ 'id' : data.id,
					  'text' : data.name,
					  'description' : data.definition
				});
				suggestions_obj = scaleSuggestions_obj;
			}
			
			//set description field to empty
			if (description == null) {
				description = $("#"+combo.toLowerCase()+"Description"); 
			}
			description.val("");
			
			//recreate the dropdown
	    	$("#combo" + combo).select2({
	    			query: function (query) {
	  	              var data = {results: suggestions_obj}, i, j, s;
	  	              // return the array that matches
	  	              data.results = $.grep(data.results,function(item,index) {
	  	                return ($.fn.select2.defaults.matcher(query.term,item.text));
	  	              
	  	              });
	  	              if (data.results.length === 0) data.results.unshift({id:query.term,text:query.term});
	  	              
	  	                query.callback(data);
	  	            }		
	    	});
		}
		
		var hasPageError = /*[[${ontologyBrowserForm.hasError}]]*/;
		
	    function do_validation() {
	    	var message = null;
		    if ($("#variableName").val() == "" || $("#dataType").val() == "" || $("#role").val() == "" || 
		    		$("#comboTraitClass").val() == "" || $("#comboProperty").val() == "" || 
		    		$("#comboMethod").val() == "" || $("#comboScale").val() == "") {
		    	
		    	message = /*[[#{ontology.browser.modal.error}]]*/;
		    	$("#page-message-modal").html(
					    "<div class='alert alert-danger'>"+ message +"</div>"
				);
				  
				return false;
		    }
		    
		    if (($("#comboTraitClass").select2("data").id == $("#comboTraitClass").select2("data").text && 
		    		$("#comboTraitClass").select2("data").description == undefined) || 
		    		($("#comboProperty").select2("data").id == $("#comboProperty").select2("data").text && 
    				$("#comboProperty").select2("data").description == undefined) || 
    				($("#comboMethod").select2("data").id == $("#comboMethod").select2("data").text && 
 					$("#comboMethod").select2("data").description == undefined) || 
 					($("#comboScale").select2("data").id == $("#comboScale").select2("data").text && 
					$("#comboScale").select2("data").description == undefined)) {
		    	
		    	message = /*[[#{ontology.browser.modal.invalid.value}]]*/;
		    	$("#page-message-modal").html(
					    "<div class='alert alert-danger'>"+ message +"</div>"
				);
		    	
		    	return false;
		    }
	    }
	    
	    function clearFields() {
	    	$("div.modal .form-control").val("");
	    }
    //]]>
    </script>
</div>