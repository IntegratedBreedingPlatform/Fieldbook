<div class="col-md-7" xmlns:th="http://www.thymeleaf.org">
	<!-- Modal -->
   	<div class="modal fade" id="selectTrialInstanceModal" role="dialog" aria-labelledby="selectTrialInstanceLabel" aria-hidden="true">
		<div class="modal-dialog modal-large">
	    	<div class="modal-content">
	         	<div class="modal-body" id="selectTrialInstanceBody">
	         		<div>
	         			<button id="closeSelectTrialInstanceModal" type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
	         		</div>
	         		<br/><br/>
	         		<div id="page-message">
	         		</div>
	         		<div>
	         			<label class="control-label" th:text="#{fieldmap.select.trial.instance}+':'">Select a Trial Instance:</label>
	         			<br/>
	         		</div>
	         		<table class="table tree table-bordered" id="studyTree" style="margin-left:5px;">
			        </table>
	         	</div>																							
	       		<div class="modal-footer">    
	       			<button type="button" class="btn btn-primary" onclick="javascript: viewFieldMap();" aria-hidden="true">OK</button>	
       			</div>
	     	</div><!-- /.modal-content -->
   		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->
</div>

<div layout:fragment="page-script">
	<script type="text/javascript" th:src="@{/static/js/jquery.treegrid.js}"></script>
	<script type="text/javascript" th:src="@{/static/js/jquery.treegrid.bootstrap3.js}"></script>		
	<script type='text/javascript' th:inline="javascript">
	//<![CDATA[    
        var noSelectedTrialInstance = /*[[#{fieldmap.no.selected.trial.instance}]]*/;
        var multipleSelectError = /*[[#{common.error.select.one.trial.instance}]]*/;
        var entryLabel = /*[[#{fieldmap.trial.number.of.entries}]]*/;
        var repLabel = /*[[#{fieldmap.trial.number.of.reps}]]*/;
        var plotLabel = /*[[#{fieldmap.trial.total.number.of.plots}]]*/;
        var fieldmapLabel = /*[[#{fieldmap.has.fieldmap}]]*/;
        var entryPlotLabel = /*[[#{fieldmap.trial.number.of.entries.and.plots}]]*/;
        
		var trial = true;
		var isViewFieldmap = true;
		
		function viewFieldMap() {
			if (isViewFieldmap) {
				showGeneratedFieldMap();
			} else {
				showCreateFieldMap();
			}
		}
		
		function showGeneratedFieldMap() {
			if ($('#studyTree .field-map-highlight').attr('id')) {
				if ($('#studyTree .field-map-highlight').size() == 1) {
					$("#selectTrialInstanceModal").modal("toggle");
					var id = $('#studyTree .field-map-highlight').attr('id');
					var datasetId = $('#studyTree .field-map-highlight').treegrid('getParentNode').attr("id");
					location.href = "/Fieldbook/Fieldmap/generateFieldmapView/viewFieldmap/trial/" + datasetId + "/" + id;
				} else {
					showMessage(multipleSelectError);
				}
			} else {
				showMessage(noSelectedTrialInstance);
			}
		}
		
		function showCreateFieldMap() {
			if ($('#studyTree .checkInstance:checked').attr('id')) {
				var selectedWithFieldMap = false;
				var ids = [];
				$('#studyTree .checkInstance:checked').each(function(){
					var id = this.id;
					var datasetId = $(this).parent().parent().treegrid('getParentNode').attr("id");
					var studyId = $(this).parent().parent().treegrid('getParentNode').treegrid('getParentNode').attr("id");
					var hasFieldMap = $(this).parent().next().next().next().next().html();
					
					//build id list of selected trials instances
					ids.push(studyId+"|"+datasetId+"|"+id);
					if (hasFieldMap == "Yes") {
						selectedWithFieldMap = true;
					}
				});
				if (selectedWithFieldMap) {
					showMessage("Are you sure you want to overwrite existing fieldmaps?");
				} else {
					//redirect to step 1
					location.href = $('#fieldmap-url').attr("href") + "/" + encodeURIComponent(ids.join(","));
				}
			} else {
				//no trial instance is selected
				showMessage(noSelectedTrialInstance);
			}
		}
    //]]>
    </script>
</div>